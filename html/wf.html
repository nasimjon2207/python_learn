

<!DOCTYPE html>
<!--[if lt IE 7]><html class="ie6 oldie" lang="zh"><![endif]-->
<!--[if IE 7]><html class="ie7 oldie" lang="zh"><![endif]-->
<!--[if IE 8]><html class="ie8 oldie" lang="zh"><![endif]-->
<!--[if gt IE 8]><!--> <html lang="zh"> <!--<![endif]-->
<head>
<meta http-equiv="X-UA-Compatible" content="edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="renderer" content="webkit">
<!--[if lt IE 7]>
<meta http-equiv="refresh" content="0; url=http://miwifi.com/cgi-bin/luci/web/ieblock" />
<![endif]-->
<!--[if gte IE 9]>
<style>
body {
   filter: none;
}
</style>
<![endif]-->
<title>Mi Router</title>
<meta name="viewport" content="width=1200">
<link href="/xiaoqiang/web/css/bc.css?v=0.0.3" rel="stylesheet">
<link href="/xiaoqiang/web/css/qos.css?v=0.0.3" rel="stylesheet">
<link href="/xiaoqiang/web/css/index.css?v=0.0.3" rel="stylesheet">
</head>
<body>
<div id="doc">
    
<noscript>
<div class="noscript">If you disable JavaScript, you won&#39;t be able to access miwifi.com to manage your router.</div>
</noscript>
<script>
var GLOBALHEADER = true;
</script>
<div id="hd">
    <div class="inner">
        <div class="mod-head clearfix">
            <h1 id="logo"><a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/home"><img src="/xiaoqiang/web/img/logo.png?v=" alt="Mi Router"></a></h1>
            <div id="nav">
                <!-- netMode header=0 -->
                
                <ul>
                    <li class="active"><a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/home">Status</a></li>
                    
                    <li ><a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/wifi">Settings</a></li>
                    <li ><a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/prosetting/qos">Advanced</a></li>

                </ul>
                
            </div>
            <div id="userbar">
               
                


                
                   <span id="addMesh" style="cursor:pointer;margin-top:6px;margin-left:15px">Add a Mesh node</span>
                

                <span id="sysmenu" class="name s-dropdown">Xiaomi_6534 (Дом)</span>
                <span id="sysnotice" class="ico-notice"></span>
            </div>
        </div>

        

        

        

        
    </div>
</div>

<script type="tmpl/html" id="tmplMeshMode">
<div class="netmode-switch-dialog-cont">
    <div class="switch-step step-select" id="mesh-select" style="display:block;overflow:hidden;">
        <div class="mesh_title">Add a Mesh node</div>
        <div class="mesh_content" style="color:#000">
            <p style="font-weight: bold;">There are two methods for adding satellite router to a mesh network, as indicated below</p>
            <p style="font-weight: bold;margin-top:6px">Wireless networking:</p>
            <p style="margin-top:6px;">1.Take the router that has not been configured as a satellite node and place it in the room to be covered byneeds Wi-Fi signal</p>
            <p style="color:#979797;;">* Please make sure that the satellite node has not been pre-configured. If the satellite node has already been configured, press and hold the Reset button on the device for at least 5 seconds to reset</p>
            2. Connect the power of the satellite node and wait for the System indicator to turn constant blue or white (the colour depends on the specific model)<br/>
            3. Click to start searching<br/>
            <p style="margin-top:6px;font-weight: bold;">Using a network cable:</p>
            1. Connect the WAN port of the unconfigured satellite node with the LAN port of the central access point through the network cable.<br/>
            2. Power on the satellite node, and the networking automatically starts after the start-up is completed (the Internet indicator of the satellite node blinks during networking).<br/>
           <!-- 1.Put the Mesh node you are adding near to the central access point.<br/>
           2.The node should be no more than 3 meters away from the central access point.<br/>
           3.Power on the node and wait for the router system indicator to turn blue. -->
        </div>
        <button class="mesh_buttons" id="mesh_search">Start search</button>
    </div>
    <div id="mesh-overMaxLength" class="switch-step">
         <div class="mesh_title">Attention</div>
         <div class="mesh_content">
              <p class="content">
             For an excellent meshnet experience, one network can support up to 10 mesh routers. For additional routers we recommend setting up a separate, new mesh network.
              </p>
          </div>
           <button class="mesh_buttons" id="mesh-close-button">Got it</button>
    </div>
     <div id="mesh-Off-5G" class="switch-step">
         <div class="mesh_title">Adding Mesh Nodes</div>
         <div class="mesh_content">
              <p class="content">
             To search for and add mesh nodes, first go to the Wi-Fi Settings page and enable 5G Wi-Fi.
              </p>
          </div>
           <button class="mesh_buttons" id="setting-5G-button">Accessing and Enabling</button>
    </div>
    <div class="switch-step step-search-loading" id="mesh-search-loading">
        <div class="mesh_title">Search for the Mesh node you wish to add</div>
        <img id="loading_mesh" src="/xiaoqiang/web/img/mesh_loading.png"/>
        <div class="mesh_content" style="text-align:center">Searching Mesh nodes...</div>
        <button class="mesh_buttons" id="mesh_search_cancle">Cancel</button>
    </div>
    <div class="switch-step step-search-lists"  id="mesh-search-lists">
        <div class="mesh_title">Please select the Mesh node you are adding</div>
        <div class="list_box"></div>
        <button class="mesh_Dbuttons mesh_add_Dbuttons " id="show_locate_select">Add</button>
        <button class="mesh_Dbuttons mesh_research_Dbuttons" id="mesh-research-btn">Try again</button>
    </div>
    <div id="mesh_list_length0"  class="switch-step">
      <div class="mesh_title">No usable Mesh node found</div>
      <img class="fail_me" src="/xiaoqiang/web/img/mesh_fail.png"/>
      <div class="mesh_content">
          <p class="content">
            No usable Mesh node found:<br/>
            1.Make sure the router you are adding supports Mesh features;<br/>
            2.Upgrade the Mesh node to the latest version;<br/>
            3.Put the Mesh node you are adding near the central access point;<br/>
            4.Power on the Mesh node you are adding;<br/>
            5. Hold down the Reset button to restore the router to factory settings and then try again.
          </p>
      </div>
      <button class="mesh_buttons" id="mesh_re_search">Search Again</button>
    </div>
    <div class="switch-step step-add-loading"  id="mesh-add-loading">
        <div class="mesh_title">Extending the Mesh network</div>
        <img id="loading_mesh" src="/xiaoqiang/web/img/mesh_loading.png"/>
        <p class="head">Connecting the Mesh node</p>
    </div>
    <div class="switch-step step-add-success"  id="mesh-add-success">
        <div class="mesh_title">Mesh network extension succeeded</div>
        <img class="success_me" src="/xiaoqiang/web/img/mesh_success.png"/>
        <div class="mesh_content">
             Congratulations, Wi-Fi coverage is enhanced!<br/>
            1. Put the new Mesh node where you need Wi-Fi coverage. <br/>
            2. Wait for the new router to appear in the admin list. <br/>
            3. The new Mesh node has the same Wi-Fi settings of the old one.
        </div>
        <button class="mesh_buttons" id="mesh_add_success">Done</button>
    </div>
    <div class="switch-step step-add-failer"  id="mesh-add-failer">
    <div class="mesh_title">Mesh network extension failed</div>
        <img class="fail_me" src="/xiaoqiang/web/img/mesh_fail.png"/>
        <div class="mesh_content">
          1. Put the Mesh node you are adding near the central access point.<br/>
          2. Restore the Mesh node to factory settings then try again.
        </div>
        <button class="mesh_buttons" id="mesh_re_try">Try again</button>
    </div>
    <div id="mesh-local" class="switch-step" style="display:none;">
      <div class="mesh_title">Select location</div>
      <div class="mesh_content">
      <div class="form-item-select">
        <select id="locateSelect" name="locateSelect" class="beautify">
          <option selected value="Living room">Living room</option>
          <option value="Bed room">Bed room</option>
          <option value="Guest room">Guest room</option>
          <option value="Study">Study</option>
          <option value="Kitchen">Kitchen</option>
          <option value="Office">Office</option>
          <option value="Basement">Basement</option>
          <option value="Bathroom">Bathroom</option>
          <option value="Loft">Loft</option>
          <option value="Balcony">Balcony</option>
          <option value="Dining room">Dining room</option>
        </select>
      </div>
      </div>
      <button class="mesh_buttons" id="mesh_search_add">OK</button>
    </div>
</div>
</script>
<script type="tmpl/html" id="nrlyTips">
    <p style="margin-bottom:30px">For technical reasons, Mesh networking functionality is not supported at this time.</p>
    <button class="mesh_buttons" id="mesh-close-button">Got it</button>
</script>

    <div class="mod-netmap">
        <div class="inner clearfix">
            <div class="devices nav-tab">
                <div class="img"></div>
                <p>Devices</p>
                <div class="status status-devices" id="statusDevices"><b class="devcountonline devcountonline1">--</b>devices</div>
            </div>
            <div id="devline" class="line line-scaning"></div>
            <div class="router nav-tab active">
                <div class="img">
                    <img class="on" src="/xiaoqiang/web/img/icons/router_rb01_100_on.png">
                    <img class="off" src="/xiaoqiang/web/img/icons/router_rb01_100.png">
                </div>
                <p>Xiaomi_6534 (Дом)</p>
                <table class="status-wifi" id="statusWifi">
                
                    <tr>
                        <td class="l">
                            <div class="status"><i id="ssid24status" class="ico ico-wifi-on"></i><span>2.4G: </span><b id="ssid24val">--</b></div>
                        </td>
                        <td class="c">|</td>
                        <td class="r">
                            <div class="status"><i id="ssid50status" class="ico ico-wifi-on"></i><span>5G:</span><b id="ssid50val">--</b></div>
                        </td>
                    </tr>
                
                </table>
            </div>
            <div id="netline" class="line line-scaning"></div>
            <div class="internet nav-tab active">
                <div class="img"></div>
                <p>Internet</p>
                <div class="status status-internet" id="statusInternet"></div>
            </div>
        </div>
    </div>
    <div id="bd">
        <div class="mod-devicestatus nav-tab-content" style="display:none;">
            <div id="devicesTables"></div>
        </div>
        <div class="mod-routerstatus nav-tab-content clearfix">
            <div class="routerinfo nomeshInfo">
                <!-- <div class="hd">
                    <h3>Router info</h3>
                </div> -->

                <div class="wifi_set">
                    <div class="wifi_2g">
                        <ul>
                             <li> <b>2.4G</b><span>Hz</span></li>
                            <li class="wifi_2g_name">Wi-Fi name</li>
                            <li class="passwd_2g">Password： 
                                <input type="text" class="wifi_2g_pssswd wifi_2g_pssswd_txt" style="padding: 5px;" value="" readonly>
                                <input type="password" class="wifi_2g_pssswd" value="" readonly> 
                                 <span class="eye2"></span>
                            </li>
                            <li class="wifi_2g_online">Clients --</li>
                        </ul>
                        <a class="btn_wifi" href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/wifi" >set</a>
                    </div>
                   
                    <div class="wifi_5g">
                        <ul>
                            <li> <b>5G</b><span>Hz</span></li>
                             <li class="wifi_5g_name">Wi-Fi name</li>
                            <li class="passwd_5g">Password：
                                <input type="text" class="wifi_5g_pssswd wifi_5g_pssswd_txt" style="padding: 5px;" value="" readonly>
                                <input type="password" class="wifi_5g_pssswd" value="" readonly> 
                                <span class="eye2"></span>
                            </li>
                            <li class="wifi_5g_online">Clients --</li>
                        </ul>
                        <a class="btn_wifi" href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/wifi" >set</a>
                    </div>
                </div>
                <div class="bd">
                    <table>
                        <tr>
                            <th>Model</th>
                            <th>System version</th>
                            <th>MAC address</th>
                            <th>SN</th>
                        </tr>
                        <tr>
                            <td id="routermodel" class="routermodel">--</td>
                            <td id="routerversion" class="routerversion">--</td>
                            <td id="routermac" class="routermac">--</td>
                            <td id="routersn" class="routersn">--</td>
                        </tr>
                        
                    </table>
                </div>
            </div>
          

          
        </div>
        <div class="mod-internetstatus nav-tab-content" style="display:none;">
            <div class="internet-panel first">
                <div class="hd">
                    <h3>Internet connection</h3>
                </div>
                <div class="bd">
                    <table id="wanStatusContent"></table>
                </div>
            </div>

            <div class="internet-panel">
                <div class="hd">
                    <h3>Internet bandwidth</h3>
                </div>
                <div class="bd">
                    <table>
                        <tr class="first">
                            <td>
                                <dl>
                                    <dt>Download bandwidth</dt>
                                    <dd><span id="banddownload">--</span>Mbps</dd>
                                </dl>
                            </td>
                            <td>
                                <dl>
                                    <dt>Upload bandwidth</dt>
                                    <dd><span id="bandupload">--</span>Mbps</dd>
                                </dl>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <!-- <a id="btnSpeedTest" href="#" class="btn btn-primary btn-m"><span id="retestSpeed">Test again</span></a> -->
                                <a id="btnBandset" href="#" class="btn btn-dft btn-primary btn-m"><span id="manualSetting">Add manually</span></a>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="hr"></div>
        </div>
    </div>
    
<div id="ft">
    <p class="rom-ver">Version: 1.0.83 Release  MAC address: 5C:02:14:48:65:34</p>
    <p>&copy; 2022 Mi Router<p>
</div>

    <div id="newguide" class="newguide" style="display:none;">
        <div class="mask"></div>
        <img src="/xiaoqiang/web/img/en/newguide.png" />
    </div>
</div>
<script type="text/tmpl" id="tmpldeviceswrap">
<table class="mod-table-devices">
    <thead>
        <tr>
            <th class="s0">{$devtype}</th>
        {if($devlen > 0 )}
            <th class="s1">Internet access</th>
            {if($hasDisk)}
            <th class="s2">Samba read</th>
            {/if}
        {/if}
        </tr>
    </thead>
    <tbody>
    {$deviceslist}
    </tbody>
</table>
</script>
<script type="text/tmpl" id="tmpldevicesitem">
<tr class="device-item">
    <td>
       <!--  <img class="dev-icon" width="60" src="{$devices_icon}" onerror="this.src='/img/device_list_error.png'"> -->
        <div class="dev-info">
            <div class="name">{$name} &nbsp;&nbsp;{if($isself)}<span class="muted">|&nbsp;Current device</span>{/if}</div>
            <ul class="devnetinfo clearfix">
               <!--  <li><span class="k">Connected:</span> <span class="v">{$online}</span></li> -->
                <li>
                    {for(var i=0, len=$ip.length; i<len; i++)}
                    <p><span class="k">IP address:</span> <span class="v">{$ip[i]}</span></p>
                    {/for}
                </li>
                <li><span class="k">MAC address:</span> <span class="v">{$mac}</span></li>
            </ul>
        </div>
    </td>

     {if($d_is_ap != 8)}
    <td class="option">
        {$option}
    </td>
    {/if}

     {if($d_is_ap == 8)}
     <td class="option_d01"></td>
      {/if}

    {if($hasDisk)}
    <td class="option2">
        {$option2}
    </td>
    {/if}
</tr>
</script>

<script type="text/tmpl" id="tmplWaninfo">
<tr class="first">
    <td>
        <dl>
            <dt>Connection type</dt>
            <dd>{$wantype}</dd>
        </dl>
    </td>
    <td>
        <dl>
            <dt>IP address</dt>
            <dd>{$ip}</dd>
        </dl>
    </td>
</tr>
<tr> 
    <td>
        <dl>
            <dt>DNS</dt>
            <dd>{$dns}</dd>
        </dl>
    </td>
    <td>
        <dl>
            <dt>Gateway address</dt>
            <dd>{$gateway}</dd>
        </dl>
    </td>
</tr>
</script>
<script type="text/tmpl" id="tmpldevicesempty">
<tr class="empty">
    <td colspan="3">No devices connected</td>
</tr>
</script>
<script type="text/tmpl" id="tmpldevices5gempty">
<tr class="empty">
    <td colspan="3">
        <div class="devices5gempty">
            <i class="ico-wifi-5g"></i>
            <h4>当前未有5G连网设备</h4>
            <p>5G Wi-Fi is faster and better for your TV or other devices not far from the router</p>
            
        </div>
    </td>
</tr>
</script>

<script type="text/tmpl" id="tmpldevicesguestempty">
<tr class="empty">
    <td colspan="3">
        
        <div class="devicesguestempty">
            <i class="ico-wifi-guest"></i>
            <h4>Guest mode is off</h4>
            <p>Networks are completely independent from each other.</p>
            <a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/wifi" class="btn btn-dft btn-l"><span>Turn on Guest Wi-Fi</span></a>
        </div>
        
    </td>
</tr>
</script>
<script type="text/tmpl" id="tmpl-task">
<div class="task-list">
    {if($appInfos.length > 0)}
    <table class="table">
        <tr class="{$order}">
            <th>Task name</th>
            <th><span class="orderbycpu">CPU</span></th>
            <th><span class="orderbymem">Memory</span></th>
            <th width="80">Operate</th>
        </tr>
        {for (var i = 0; i < $appInfos.length; i++)}
        <tr>
            <td>{$appInfos[i].name}</td>
            <td>{$appInfos[i].cpu}%</td>
            <td>{$appInfos[i].mem}%</td>
            <td><a href="###" class="btn btn-dft btn-s killtask" data-status="{$appInfos[i].status}" data-id="{$appInfos[i].id}" data-pname="{$appInfos[i].name}"><span>
            {if($appInfos[i].status == 5)}End{/if}
            {if($appInfos[i].status == 7 || $appInfos[i].status == 6)}Turn on{/if}
            </span></a></td>
        </tr>
        {/for}
    </table>
    {else}
    <p>No task running</p>
    {/if}
</div>
</script>
<script type="text/html" id="tmplVaslist">
<li>
    <p class="p1">{$title}</p>
    <p class="p2" title="{$desc}">{$desc}</p>
    <img src="/vas/{$icon}">
    <input type="checkbox" name="vaskey" data-key="{$postkey}" checked="checked" />
</li>
</script>

<!--[if lt IE 7]>
<script>
    try {
        document.execCommand("BackgroundImageCache", false, true);
    } catch (e) {
    }
</script>
<![endif]-->
<div class="mask-menu" id="maskMenu"
     style="position:fixed;left:0;top:0; width:100%; height:100%; z-index:2; display:none;"></div>
<div id="dropmenu" class="dropmenu" style="z-index:3; display:none;">
    <ul>
        <li><a href="#" id="toRename">Change router name</a></li>
        
        <li><a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/upgrade">System update</a></li>
        
        <li><a href="#" id="toDownloadClient">Download the Mi Home/Xiaomi Home app</a></li>
        <li><a href="#" id="toReboot">Reboot</a></li>
        
        <li class="last"><a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/logout">Sign out</a></li>
    </ul>
</div>
<div id="noticebar" class="noticebar" style="z-index:3; display:none;">
    <i class="ico-arrow"></i>
    <div class="content"></div>
</div>
<script>
var i18n = {};
i18n.dialog = {
	ok: 'OK',
	cancel: 'Cancel',
	loading: 'Loading…',
	dlgtitle: 'Message box'
};
i18n.valid = {
    n_integer: 'Enter a complete {$0}',
    n_format: 'Use the following format &#34;{$0}&#34;',
    n_upper: 'Enter up to {$0}', //注意：{$0}表示允许值，{$1}表示实际值
    n_lower: 'Use {$0} characters or more',
      n_negative: '请输入一个2位负整数。',
    nrange_from: 'The range you entered is invalid',
    nrange_to: 'The range you entered is invalid',
    n_useless_zero: 'Looks like there&#39;s an additional &#34;0&#34; at the beginning of the value you entered.',
    d_format: 'Date format: YYYY-MM-DD',
    d_upper: 'Date can&#39;t be later than {$0}',
    d_lower: 'Date can&#39;t be earlier than {$0}',
    daterange_from: 'Start date can&#39;t be later than end date.',
    daterange_to: 'End date can&#39;t be earlier than start date',
    daterange_larger_span: "Can&#39;t exceed {$0} days",
    text_longer: 'Use {$0} characters or less', //'{$1}字太多，最多允许{$0}字'
    text_shorter: 'Enter {$0} characters or more', //'{$1}字太少，最少允许{$0}字'
    bytetext_longer: 'Use {$0} characters or less', //'{$1}字节太多，最多允许{$0}字节'
    bytetext_shorter: 'Enter {$0} characters or more', //'{$1}字节太少，最少允许{$0}字节'
    richtext_longer: 'Use {$0} characters or less',
    richtext_shorter: 'Enter {$0} characters or more',
    _reconfirm: 'Passwords don&#39;t match.',
    _time: 'The format of the date you entered is invalid.',
    _minute: 'The format of the date you entered is invalid.',
    _email: 'Check the email address you entered',
    _mobilecode: 'Check the phone number you entered',
    _phone: 'Check the phone number you entered',
    _phonewithext: 'Check the phone number you entered',
    _phonezone: 'Check the area code you entered',
    _phonecode: 'Check the phone number you entered',
    _phoneext: 'Check the phone number extension you entered',
    _zipcode: 'Check the zip code you entered',
    _idnumber: 'Check the ID number you entered (Only 15 and 18 characters are supported)',
    _bankcard: 'Check the account number you entered',
    _cnname: 'Check the name you entered',
    _vcode: 'Check the verification code you entered',
    _imgfile: 'Only jpg, jpeg, png, gif, tif, or bmp file types are supported.',
    _regexp: 'Check input fields',
    _magic: 'Check input fields',
    _req_text: 'Enter {$0}.',
    _req_select: 'Select {$0}',
    _req_file: 'Upload {$0}',
    _logicrequired: '{$0} is invalid.',
    _ssid: 'The router name you entered is invalid',
    _macaddr: 'MAC address format is invalid',
    _weppassword: 'The password you entered is incorrect',
    _wifipassword: 'Please enter numbers, English letters or symbols',
    _ipaddr: 'IP address consists of four numbers, each ranging from 0-255, separated by dots (e.g. 120.134.33.9)',
    _ipv6addr: 'An IPv6 address is represented as eight groups of four hexadecimal digits, with every group separated by a colon (:)',
    _ipv6addrprefix: 'LAN IPv6 prefixes must end with ::',
    _url: 'Enter full URL (e.g. http://miwifi.com)',
    _vlan:'Check input fields 1-4094',
    _valnpriorty:'Check input fields 0-7',
    _routerpwd:'至少包含大写字母、小写字母、符号、数字中的三类字符',
    _server:'请检查您的输入'
};
</script>
<script src="/js/jquery-1.8.3.js?v=0.0.3"></script>
<script src="/js/qwrap.js?v=0.0.3"></script>
<script src="/js/common.js?v=0.0.3"></script>
<script src="/js/raphael.js?v=0.0.3"></script>
<script src="/js/crypto-js/rollups/sha1.js?v=0.0.3"></script>
<script src="/js/crypto-js/rollups/aes.js?v=0.0.3"></script>
<script src="/js/valid.js?v=0.0.3"></script>
<script src="/xiaoqiang/web/js/selectbeautify.js?v=0.0.3"></script>
<script src="/xiaoqiang/web/js/jquery.dialog.js?v=0.0.3"></script>
<script src="/xiaoqiang/web/js/jquery.cookie.js?v=0.0.3"></script>
<script>
    (function () {
        var G_FEATURES = $.parseJSON('{"netmode":{"elink":"0"},"hardware":{"disk":"0","usb_deploy":"0","usb":"0"},"wifi":{"wifimerge":"1","wifiguest":"1","wifi24":"1","wifi50":"1"},"apps":{"apptc":"0","qos":"1"},"apmode":{"lanapmode":"1","wifiapmode":"1"},"system":{"infileupload":"1","downloadlogs":"0","GdprPrivacy":"1","shutdown":"0","i18n":"0","https":"1","task":"0"}}');
        window['G_FEATURES'] = G_FEATURES;
    }())
</script>

<script>
// reboot
var global_api_reboot = {
	url : '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/reboot',
	param : {"client":"web"}
};
function reboot_window( needconfirm ) {
	console.log( needconfirm );
	var reboot = function(){
			$.getJSON( global_api_reboot.url, global_api_reboot.param, function( rsp ) {
				if( rsp.code !== 0 ){
					$.alert( rsp.msg ).time( 1.5*1000 );
				} else {
					var ip = rsp.lanIp[0].ip;
					rebootWait( {
						lanIp : ip,
						action : 'Reboot router',
						refresh : true
					} );
				}
			});
		};
	if ( typeof( needconfirm ) !== "undefined" && needconfirm === false ) {
		reboot();
		return;
	}
	$.confirm('Devices will be disconnected from network while router reboots.',function () {
			var dlg = this;
			reboot();
			dlg.close();
			return false;
		});
}
// shutdown
function shutdown_window(){
	$.confirm('All devices will be disconnected from router.', function () {
			$.getJSON( '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/shutdown', {}, function( rsp ){
				if( rsp.code !== 0 ){
					$.alert(rsp.msg).time( 1.5*1000 );
				} else {
					$.loadingDialog({
						title: 'Turn off router',
						content: 'Wait until router&#39;s notification light turns off before you disconnect power source.'
					});
				}
			});
		});
}
//reset
function reset_window( format ){

	var reset = (function( format ){
		var requestURL = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/reset',
			requestData = {
				format: format ? 1 : 0
			},
			wait = function(){
				rebootWait( {
					action : 'Factory data reset',
					refresh : true,
					lanIp: '192.168.31.1'
				} );
			},
			clearCookies = function (){
				var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
				if ( keys ) {
					for (var i = keys.length; i--;){
						document.cookie = keys[i]+'=0;path=/;expires=' + new Date(0).toUTCString();
					}
				}
			};

		return function(){
			$.getJSON( requestURL , requestData, function( rsp ) {
				if ( rsp.code !== 0 ) {
					$.alert( rsp.msg ).time( 3*1000 );
				}else{
					// clear cookies
					clearCookies();
					//block wait
					wait();
				}
			});
		}
	})( format );

	$.confirm('Restore router to its factory settings? You can&#39;t reverse this action.', function(){
		reset();
	});
}
</script>
<script type="text/tmpl" id="tplrename">
<div class="mod-rename-dlg">
    <p class="img"><img src="/xiaoqiang/web/img/topograph/router_rb01_100.png"></p>
    <div class="form-rename">
        <form action="#" class="form" id="routerNameEdit">
            <div class="form-item">
                <label class="k">Name</label>
                <span class="v">
                    <input type="text" name="routername" id="routername" class="ipt-text" autocomplete="off" datatype="bytetext" maxlength="24" reqMsg="Name" value="{$name}">
                </span>
                <em class="t"></em>
            </div>
            <div class="form-item">
                <label class="k">Location</label>
                <span class="v">
                    <input type="text" name="locale" id="locale" class="ipt-text" autocomplete="off" datatype="bytetext" maxlength="24" reqMsg="Location" value="{$locale}">
                </span>
                <em class="t"></em>
            </div>
            <div class="form-contral">
                <button type="submit" class="btn btn-primary btn-l"><span>Save</span></button>
            </div>
        </form>
    </div>
</div>

</script>
<script type="text/tmpl" id="tplshutdown">
<div class="mod-reboot-dlg">
    <p class="img"><img src="/xiaoqiang/web/img/ico_shutdown.png"></p>
    <p class="text">All devices will be disconnected from router&#39;s network.</p>
    <button id="shutdownAction" type="button" class="btn btn-primary btn-l"><span>Turn off router</span></button>
</div>

</script>
<script type="text/tmpl" id="tplreboot">
<div class="mod-shutdown-dlg">
    <p class="img"><img src="/xiaoqiang/web/img/ico_reboot.png"></p>
    <p class="text">Devices will be disconnected from network while router reboots.</p>
    <button type="button" id="rebootAction" class="btn btn-primary btn-l"><span>Reboot router</span></button>
</div>

</script>
<script type="text/tmpl" id="tpldowncn">
<div class="mod-downloadclient-dlg">
    <table>
        <tr>
            <td>
                <i class="ico-down-client ico-down-pc"></i>
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqpc_client.exe">Windows</a>
            </td>
            <td class="c1"></td>
            <td class="c2"></td>
            <td>
                <i class="ico-down-client ico-down-mac"></i>
                <a href="http://bigota.miwifi.com/xiaoqiang/client/xqmac_client.dmg">OSX</a>
            </td>
        </tr>
        <tr class="last">
            <td>
                <i class="ico-down-client ico-down-andriod"></i>
                <a href="http://www1.miwifi.com/pc2app_download.html">手机客户端</a>
            </td>
            <td class="c1"></td>
            <td class="c2"></td>
            <td>
                <i class=" ico-down-code"></i>
            </td>
        </tr>
    </table>
</div>

</script>
<script type="text/tmpl" id="tpldownintl">
    <img style="width:183px;height:183px" class="onlineimg" src-local="/xiaoqiang/web/img/miHome.png" src="/xiaoqiang/web/img/miHome.png">
    <p>Scan the QR code with your smartphone to install the Mi Home/Xiaomi Home app</p>

</script>
<script>
    var DEBUG = false;
    if (!window.console || DEBUG == false) {
        window.console = {
            log: function () {
            }
        };
    }

    var Encrypt = {
        key: 'a2ffa5c9be07488bbb04a3a47d3c5f6a',
        iv: '64175472480004614961023454661220',
        nonce: null,
        init: function () {
            var nonce = this.nonceCreat();
            this.nonce = nonce;
            return this.nonce;
        },
        nonceCreat: function () {
            var type = 0;
            var deviceId = '20:4e:f6:26:cd:4f';
            var time = Math.floor(new Date().getTime() / 1000);
            var random = Math.floor(Math.random() * 10000);
            return [type, deviceId, time, random].join('_');
        },
        oldPwd: function (pwd) {
            return CryptoJS.SHA1(this.nonce + CryptoJS.SHA1(pwd + this.key).toString()).toString();
        },
        newPwd: function (pwd, newpwd) {
            var key = CryptoJS.SHA1(pwd + this.key).toString();
            key = CryptoJS.enc.Hex.parse(key).toString();
            key = key.substr(0, 32);
            key = CryptoJS.enc.Hex.parse(key);
            var password = CryptoJS.SHA1(newpwd + this.key).toString();
            var iv = CryptoJS.enc.Hex.parse(this.iv);
            var aes = CryptoJS.AES.encrypt(
                password,
                key,
                {iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7}
            ).toString();
            return aes;
        }
    };

    var pingRouter = function (on, off, ip) {
        var online = on || function () {
            },
            offline = off || function () {
            },
            host = ip || location.host,
            imgUrl = 'http://' + host + '/xiaoqiang/web/img/logo.png',
            time = 5000,
            timecounter = 0,
            img = null,
            wait = function () {
                console.log('pingRouter:wait');
                offline();
            },
            done = function () {
                console.log('pingRouter:done');
                window.clearInterval(timer);
                online();
            },
            loadImg = function (onload, onerror) {
                img = new Image();
                img.onload = onload;
                img.onerror = onerror;
                img.src = imgUrl + '?' + (+new Date());
            },
            timer = window.setInterval(function () {

                if ('onLine' in navigator) {
                    if (navigator.onLine) {
                        loadImg(
                            function () {
                                done();
                            }, function () {
                                wait();
                            }
                        );
                    } else {
                        wait();
                    }
                } else {
                    loadImg(function () {
                        done();
                    }, function () {
                        wait();
                    });
                }
            }, time);
    };

    var rebootWait = function (opt) {
        var action = opt.action,
            ip = opt.lanIp || window.location.host,
            refresh = opt.refresh || false,
            tStart = (+new Date()),
            tUse,
            dlgRebootWait = $.loadingDialog({
                title: 'Just a sec…',
                content: 'Waiting to reboot…'
            }),
            online = function () {
                dlgRebootWait.content('Settings applied');
                dlgRebootWait.time(3 * 1000);
                if (refresh) {
                    window.setTimeout('window.top.location.href="http://' + ip + '";', 3000);
                }
            },
            offline = function () {
                tUse = Math.round(((+new Date()) - tStart) / 1000);
                if (tUse > 150) {
                    dlgRebootWait.content('Couldn&#39;t connect to router automatically. ');
                    return;
                }
                dlgRebootWait.content(action + ', waiting for Wi-Fi restart, ({$time}seconds)'.tmpl({time: tUse}));
            };

        window.setTimeout(function () {
            pingRouter(online, offline, ip);
        }, 1000 * 60);
    };

    (function ($) {

        function formInit(container) {
            var clsInput = 'form-item form-item-input',
                clsEmpty = 'form-item form-item-empty',
                clsDisabled = 'form-item-disabled',
                clsError = 'form-item-err',
                clsPassword = 'form-item-pwd';

            container = container || 'body';
            $(container).find('.form-item input').each(function () {
                var me = this,
                    $me = $(me),
                    parent = $(me.parentNode.parentNode),
                    label = parent.find('.k'),
                    offsetX = $me.position().left;
                if (!(this.type == 'text' || this.type == 'password')) {
                    return;
                }
                // some input do not need init
                if ($me.hasClass('no-init')) {
                    return;
                }
                if (me.value !== '') {
                    parent[0].className = clsInput;
                } else {
                    parent[0].className = clsEmpty;
                    if (offsetX > 0) {
                        label.css({'left': offsetX + 10});
                    }
                }
                if (me.disabled) {
                    parent.addClass(clsDisabled);
                }
                if ($me.attr('data-type') === 'password') {
                    parent.addClass(clsPassword);
                    parent.append('<i class="bt-showpwd bt-showpwd-off"></i>');
                }

                label.on('click', function (e) {
                    try {
                        me.focus();
                    } catch (ex) {
                    }
                });

            });
            var focusHandler = function () {
                if (!(this.type == 'text' || this.type == 'password')) {
                    return;
                }
                var me = $(this),
                    parent = $(this.parentNode.parentNode),
                    label = parent.find('.k'),
                    t = parent.find('.t'),
                    classname;
                if (me.hasClass('no-init')) {
                    return;
                }
                if (parent.hasClass(clsPassword)) {
                    classname = clsInput + ' ' + clsPassword;
                } else {
                    classname = clsInput;
                }
                if (parent.hasClass(clsError)) {
                    t.hide();
                }
                // label.css({'left': 'auto'});
                label.hide();
                parent[0].className = classname;
            };
            var blurHandler = function () {
                var me = this,
                    $me = $(me),
                    parent = $(me.parentNode.parentNode),
                    classname,
                    label = parent.find('.k'),
                    offsetX = $me.position().left;
                if (!(this.type == 'text' || this.type == 'password')) {
                    return;
                }
                if ($(this).hasClass('no-init')) {
                    return;
                }
                label.show();
                if (me.value == '') {
                    if (parent.hasClass(clsPassword)) {
                        classname = clsEmpty + ' ' + clsPassword;
                    } else {
                        classname = clsEmpty;
                    }
                    if (offsetX > 0) {
                        label.css({'left': offsetX + 10});
                    } else {
                        // label.css({'left': 12});
                    }
                    parent[0].className = classname;
                }
            };
            var addInputEvent = function () {
                $(container).find('.form-item input')
                    .on('focus', focusHandler)
                    .on('blur', blurHandler);
            };

            var delInputEvent = function () {
                $(container).find('.form-item input').off('focus', focusHandler);
                $(container).find('.form-item input').off('blur', blurHandler);
            };
            // del password event
            $('body').undelegate('.bt-showpwd', 'click');
            $('body').delegate('.bt-showpwd', 'click', function (e) {
                console.log('showpwd');
                var me = this,
                    meclass = 'bt-showpwd',
                    formItem = $(this).closest('.form-item'),
                    input = formItem.find('input'),
                    inputValue = input.val(),
                    inputWrap = formItem.find('.v'),
                    newinput = '',
                    inputHTML = inputWrap.html();

                if (input.attr('type') == 'password') {
                    newinput = inputHTML.replace(/type\s*=\s*('|")?password('|")?/ig, 'type="text"');
                    inputWrap.html(newinput).find('input')[0].value = inputValue;
                    me.className = meclass + ' bt-showpwd-on';
                } else {
                    newinput = inputHTML.replace(/type\s*=\s*('|")?text('|")?/ig, 'type="password"');
                    inputWrap.html(newinput).find('input')[0].value = inputValue;
                    me.className = meclass + ' bt-showpwd-off';
                }

                setTimeout(function () {
                    delInputEvent();
                    addInputEvent();
                }, 0);
            });

            addInputEvent();
        }

        $.formInit = formInit;

    })(jQuery);

    /**
     * byte format
     */
    function byteFormat(number, precision, isarray) {
        var val,
            label,
            ret;
        precision = precision || 100,
            isarray = isarray || false;
        if (number > 1024 * 1024 * 1024) {
            val = Math.floor(number / 1024 / 1024 / 1024 * precision) / precision;
            label = 'GB';
        } else if (number > 1024 * 1024 && number < 1024 * 1024 * 1024) {
            val = Math.floor(number / 1024 / 1024 * precision) / precision;
            label = 'MB';
        } else {
            val = Math.floor(number / 1024 * precision) / precision;
            label = 'KB';
        }

        if (isarray) {
            ret = [val, label];
        } else {
            ret = val + label;
        }

        return ret;
    }


    function secondToHour(time) {
        var pint = function (num) {
                return parseInt(num, 10);
            },
            hour = pint(time / 3600.0),
            minute = pint((parseFloat(time / 3600.0) - hour) * 60),
            second = pint(time) - hour * 3600 - minute * 60,
            format = hour + 'hr' + minute + 'min' + second + 's';
        return format;
    }

    function secondToDate(second) {
        var time = parseFloat(second),
            pint = function (num) {
                return parseInt(num, 10);
            },
            day;
        if (time !== null && time !== "") {
            if (time > 60 && time < 60 * 60) {
                time = pint(time / 60.0) + 'min' + pint((parseFloat(time / 60.0) - pint(time / 60.0, 10)) * 60) + 's';
            } else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                time = secondToHour(time);
            } else if (time >= 24 * 60 * 60) {
                day = pint(time / (3600.0 * 24));
                time = time - (day * 3600 * 24);
                time = day + 'd' + secondToHour(time);
            } else {
                time = pint(time) + 's';
            }
        }
        return time;
    }

    (function ($) {
        function pint(num) {
            return parseInt(num, 10);
        }

        function secondToHour(time) {
            var hour = pint(time / 3600.0),
                minute = pint((parseFloat(time / 3600.0) - hour) * 60),
                second = pint(time) - hour * 3600 - minute * 60,
                format = hour + 'hr' + minute + 'min' + second + 's';
            return format;
        }

        function secondToDate(second) {
            var time = parseFloat(second),
                day;
            if (time !== null && time !== "") {
                if (time > 60 && time < 60 * 60) {
                    time = pint(time / 60.0) + 'min' + pint((parseFloat(time / 60.0) - pint(time / 60.0, 10)) * 60) + 's';
                } else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                    time = secondToHour(time);
                } else if (time >= 24 * 60 * 60) {
                    day = pint(time / (3600.0 * 24));
                    time = time - (day * 3600 * 24);
                    time = day + 'd' + secondToHour(time);
                } else {
                    time = pint(time) + 's';
                }
            }
            return time;
        }

        function secondToDate2(second) {
            var time = parseFloat(second),
                num = 0,
                unit = 'd';
            console.log(second, time);
            if (!isNaN(time)) {
                if (time > 60 && time < 60 * 60) {
                    num = Math.floor(time / 60.0);
                    unit = 'mins';
                } else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                    num = Math.floor(time / 3600.0);
                    unit = 'hr'
                } else if (time >= 24 * 60 * 60) {
                    num = Math.floor(time / (3600.0 * 24));
                    unit = 'd';
                } else {
                    num = Math.floor(time);
                    unit = 's';
                }
            }
            return {
                num: num,
                unit: unit
            };
        }

        $.secondToHour = secondToHour;
        $.secondToDate = secondToDate;
        $.secondToDate2 = secondToDate2;
    })(jQuery);


    $(document).ajaxSuccess(function (event, xhr, settings) {
        var rsp = xhr.responseText;
        rsp = $.parseJSON(rsp);
        // console.log(event, xhr, settings);
        var ignore = [
            'api\/xqsystem\/login',
            'api\/xqsystem\/upgrade_rom'
        ];
        for (var i = 0; i < ignore.length; i++) {
            var ignoreTest = new RegExp(ignore[i]);
            // console.log( ignoreTest );
            if (ignoreTest.test(settings.url)) {
                return;
            }
        }
        if (rsp.code === 401 || rsp.code === 403) {
            document.location.href = 'http://' + location.host;
        }
    });

    $.sub('wait', function (evt, data) {
        var selector = data.id;
        if (!$.waitStatus) {
            $.waitStatus = {};
        }
        $.waitStatus[selector] = $(selector).text();
        $(selector).addClass('btn-primary-disabled').prop('disabled', true).find('span').text('Just a sec…...');
    });

    $.sub('done', function (evt, data) {
        var selector = data.id,
            text = $.waitStatus[selector];
        $(selector).removeClass('btn-primary-disabled').prop('disabled', false).find('span').text(text);
    });

    $.sub('loading:start', function () {
        var isLoading = $('html').hasClass('isloading');
        if (isLoading) {
            return;
        }
        var tplMask = '<div id="panel-loading-mask" class="panel-mask" style="position:fixed;left:0;top:0;style:none;"></div>',
            tplLoading = ''
                + '<div id="panel-loading" class="panel-loading" style="style:none;">'
                + '<img src="/img/loading2.gif">'
                + '</div>',
            $mask = $(tplMask),
            $loading = $(tplLoading),
            zIndex = 10000;
        $mask.css({
            'z-index': zIndex,
            width: $(window).width() + 'px',
            height: $(window).height() + 'px'
        });
        $loading.css({'z-index': zIndex + 1});
        $mask.appendTo(document.body).show();
        $loading.appendTo(document.body).show();
        $('html').addClass('isloading');
    });

    $.sub('loading:stop', function () {
        $('html').removeClass('isloading');
        $('#panel-loading, #panel-loading-mask').remove();
    });

    // dialog block loading
    (function ($) {
        $.loadingDialog = function (config) {
            var mix = ObjectH.mix,
                _config = config || {
                    title: '',
                    content: ''
                },
                conf = mix(_config, {
                    width: 490,
                    padding: '25px 30px',
                    title: config.title,
                    content: '<p style="padding-bottom:30px;">{$content}</p><div class="loading-bar"></div>'.tmpl({content: config.content}),
                    cancel: false
                }, true),
                dialog = $.dialog(conf);

            var oldcontent = dialog.content;
            dialog.content = function (cont) {
                var _cont = '<p style="padding-bottom:30px;">{$content}</p><div class="loading-bar"></div>'.tmpl({content: cont});
                return oldcontent.call(dialog, _cont);
            };
            return dialog;
        }
    })(jQuery);

    // dialog block loading
    (function( $ ){
        $.radarDialog = function( config ){
            var mix = ObjectH.mix,
            _config = config || {
                title: '',
                content: ''
            },
            conf = mix( _config, {
                width: 500,
                padding:'25px 30px',
                title: config.title,
                content: '<div>{$content}</div>'.tmpl({content: config.content}),
                cancel: false
            }, true ),
            dialog = $.dialog( conf );

            var oldcontent = dialog.content;
            dialog.content = function( cont ){
            var _cont = '<p style="padding-bottom:30px;">{$content}</p><div class="loading-bar"></div>'.tmpl({content: cont});
                return oldcontent.call( dialog, _cont);
            };
            return dialog;
        }
    })(jQuery);

    // dialog alert
    (function ($) {
        $.alert = function (content, ok) {
            ok = ok || function () {
            };
            return $.dialog({
                width: 490,
                padding: '25px 30px',
                title: 'Attention',
                content: content,
                ok: ok,
                cancel: false
            });
        }
    })(jQuery);

    // dialog confirm
    (function ($) {
        $.confirm = function (content, ok, cancel) {
            var _cancel = cancel || function () {
            };
            return $.dialog({
                width: 490,
                padding: '25px 30px',
                title: 'Confirm info',
                content: content,
                ok: ok,
                cancel: _cancel,
                lock: true
            });
        }
    })(jQuery);

    // wechat code dialog
    $(function () {
        $('#wechatcode').click(function (e) {
            e.preventDefault();
            var $this = $(this),
                href = $this.attr('href');
            $.dialog({
                title: 'Official WeChat',
                content: '<img width="200" src="' + href + '">',
                width: 250,
                lock: true
            });
        });
    });


    // set sys language
    (function ($) {
        $.i18nSet = function (el) {
            var $lan = $(el),
                apiGetLan = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/get_languages',
                apiSetlan = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/set_language',
                dtd = $.Deferred();

            $.get(apiGetLan, function (rsp) {
                var rsp = $.parseJSON(rsp);
                var selectContent = [];
                if (rsp.code == 0) {
                    for (var i = 0; i < rsp.list.length; i++) {
                        var item = rsp.list[i],
                            selected = item.lang == rsp.lang ? 'selected' : '',
                            option = '<option value="' + item.lang + '" ' + selected + '>' + item['name'] + '</option>';
                        // clear old conf en item
                        // if ( item.lang != 'en') {
                        selectContent.push(option);
                        // }
                    }
                    ;
                    $lan.html(selectContent.join(''));
                    dtd.resolve();
                }
            });

            $lan.on('change', function (e) {
                var el = this,
                    val = $(this).val();
                $.pub('loading:start');
                $.post(apiSetlan, {language: val}, function (rsp) {
                    var rsp = $.parseJSON(rsp);
                    if (rsp.code == 0) {
                        location.reload(1);
                    } else {
                        $.alert(rsp.msg);
                    }
                    $.pub('loading:stop');
                });
            });

            return dtd.promise();
        };
    }(jQuery));


    // global event
    (function ($) {
        var dlgReboot,
            dlgShutdown,
            dlgRouterName;

        function getNotice() {
            $.getJSON('/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/messages', function (rsp) {
                if (rsp.code == 0) {
                    var classname;
                    if (rsp.count > 0) {
                        classname = 'ico-notice-new';
                    } else {
                        classname = 'ico-notice';
                    }
                    $('#sysnotice')[0].className = classname;
                    var msgMap = {
                        '1': '<p>Update available: {$version}，<a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/upgrade">Update now</a>。</p>',
                        '3': '<p>Couldn&#39;t turn on 5G Wi-Fi<a target="_blank" href="http://www.mi.com/service/contact/">Contact Xiaomi customer support</a></p>',
                        '4': '<p>IP conflict detected, try switching to<a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/wan#netmode">Wired amplifier mode</a>or<a href="#" id="ipconflict" data-ip="{$ip}">Avoid IP conflicts</p>'
                    };

                    var msgMapD01 = {
                        '1': '<p>Update available: {$version}，<a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/upgrade">Update now</a>。</p>',
                        '3': '<p>Couldn&#39;t turn on 5G Wi-Fi<a target="_blank" href="http://www.mi.com/service/contact/">Contact Xiaomi customer support</a></p>',
                        '4': '<p>检测到与上级路由器存在IP冲突，请<a href="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/lannetset">修改局域网IP地址网段</a></p>'
                    };

                    var msgHTML = [];
                    //rsp.messages = [{type: 4, data: {version: "0.3.78"}, timestamp: 1547150097}];
                    var hardware = 'rb01';
                    var isMesh =false;
                    if (isMesh) {
                        for (var i = rsp.messages.length - 1; i >= 0; i--) {
                            msgHTML.push(msgMapD01[rsp.messages[i].type].tmpl(rsp.messages[i].data));
                        }
                        ;
                    } else {
                        for (var i = rsp.messages.length - 1; i >= 0; i--) {
                            msgHTML.push(msgMap[rsp.messages[i].type].tmpl(rsp.messages[i].data));
                        }
                        ;
                    }

                    $('#noticebar .content').html(msgHTML.join(''));

                    if (rsp.count > 0) {
                        $('#sysnotice').trigger('click');
                    }
                }
            });
        }

        function reNameHandler(e) {
            e.preventDefault();
            $.getJSON('/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/router_name')
                .done(function (rsp) {
                    if (rsp.code == 0) {
                        var html = StringH.tmpl($('#tplrename').html(), {
                            locale: StringH.encode4HtmlValue(rsp.locale),
                            name: StringH.encode4HtmlValue(rsp.name)
                        });
                        dlgRouterName = $.dialog({
                            width: 490,
                            title: 'Change router name',
                            content: html,
                            lock: true
                        });
                        setTimeout(function () {
                            $.formInit('.mod-rename-dlg');
                            $.selectBeautify({container: '.mod-rename-dlg'});
                        }, 100);
                    }
                });
        }

        function downloadClientHandler(e) {
            e.preventDefault();
            var ccode = 'DE', content;
            if (ccode == 'CN') {
                content = $('#tpldowncn').html();
            } else {
                content = $('#tpldownintl').html()
            }
            $.dialog({
                width: 490,
                title: 'Download the Mi Home/Xiaomi Home app',
                content: content,
                lock: true
            });
            setTimeout(function () {
                $('.onlineimg').each(function () {
                    var img = new Image();
                    var el = this;
                    var remote = el.src;
                    var local = $(el).attr('src-local');
                    img.onerror = function () {
                        el.src = local;
                    }
                    img.src = remote;
                });
            }, 100);
        }

        function rebootHandler(e) {
            e.preventDefault();
            dlgReboot = $.dialog({
                width: 490,
                title: 'Reboot router',
                content: $('#tplreboot').html(),
                lock: true
            });
        }

        function shutdownHandler(e) {
            e.preventDefault();
            dlgShutdown = $.dialog({
                width: 490,
                title: 'Power off',
                content: $('#tplshutdown').html(),
                lock: true
            });
        }

        function noticeHandler(e) {
            e.preventDefault();
            var that = this,
                $this = $(this),
                pos = $('#userbar').position(),
                right,
                wt = 1160,
                wwt = $(window).width(),
                $arrow = $('#noticebar .ico-arrow');
            if ($this.hasClass('ico-notice-new')) {
                // right = wt - pos.left - 20;
                $arrow.css({'right': '10px'});
                $('#noticebar').css({'right': (wwt - wt) / 2});
                $('#noticebar').toggle();
            }
            $('#maskMenu').height($(window).height());
            $('#maskMenu').show();
        }

        function sysmenuHandler(e) {
            e.preventDefault();
            var that = this,
                $this = $(this);
            if ($this.hasClass('s-dropdown')) {
                var ww = $(window).width();
                // var rt = (ww - 1160) / 2;
                var lt = $this.offset().left + $this.outerWidth() - $('#dropmenu').width();
                $('#dropmenu').css({left: lt});
                $('#dropmenu').show();
                that.className = 'name s-dropup';
            } else {
                $('#dropmenu').hide();
                that.className = 'name s-dropdown';
            }
            $('#maskMenu').height($(window).height());
            $('#maskMenu').show();
        }

        function maskHandler(e) {
            e.preventDefault();
            $('#noticebar').hide();
            $('#dropmenu').hide();
            $('#maskMenu').hide();
            $('#sysmenu')[0].className = 'name s-dropdown';
        }

        $(function () {
            // notice
            $('#sysnotice').click(noticeHandler);
            // user dropmenu
            $('#sysmenu').click(sysmenuHandler);
            // space click
            $('#maskMenu').click(maskHandler);
            // rename
            $('body').delegate('#toRename', 'click', reNameHandler);
            // toDownloadClient
            $('body').delegate('#toDownloadClient', 'click', downloadClientHandler);
            // toReboot
            $('body').delegate('#toReboot', 'click', rebootHandler);
            // toShutdown
            $('body').delegate('#toShutdown', 'click', shutdownHandler);

            $('body').delegate('#shutdownAction', 'click', function (e) {
                e.preventDefault();
                dlgShutdown.close();
                shutdown_window();
            });

            $('body').delegate('#rebootAction', 'click', function (e) {
                e.preventDefault();
                dlgReboot.close();
                reboot_window();
            });

            $('body').delegate('#routerNameEdit', 'submit', function (e) {
                e.preventDefault();
                var validator = Valid.checkAll(this);
                var routername = $('#routername').val();
                var locale = $('#locale').val();
                if (validator) {
                    $.getJSON('/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/set_router_name', {
                        name: routername,
                        locale: locale
                    }).done(function (rsp) {
                        if (rsp.code == 0) {
                            location.reload(1);
                        } else {
                            $.alert(rsp.msg)
                        }
                    });
                }
            });

            $('body').delegate('#ipconflict', 'click', function (e) {
                e.preventDefault();
                var api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/r_ip_conflict',
                    ip = $(this).attr('data-ip');
                $.dialog({
                    title: 'Avoid IP conflicts',
                    content: 'To perform this action, your IP will be changed to' + ip + '<br>' + 'During this process, the wireless network will restart and a brief drop will occur.',
                    lock: true,
                    ok: function () {
                        $.post(api, function (rsp) {
                            rsp = $.parseJSON(rsp);
                            if (rsp.code !== 0) {
                                alert(rsp.msg);
                            }
                        });
                    },
                    cancel: function () {
                    }
                });
            });

            var meshModeDialog;
            var isClick = false; //判断是否已经点击过添加按钮，防止多次点击，多次调用接口
            $('body').delegate('#addMesh', 'click', function (e) {
                e.preventDefault();

                if (isClick) return;

                $.getJSON('/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/get_location', function(rsp){
                    if (rsp.code === 0) {//  code非0代表失败
                        // {"code":0 ,location="地区简称"}
                        //zone value
                // var apiDevicesGet = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/devicelist';
                var apiDevicesGet = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/topo_graph';
                isClick = true;
                $.getJSON('/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetwork/wifi_detail_all')
                    .done(function (rsp) {
// isClick = false;
                        if (rsp.code == 0) {
                            if (rsp.info[1].status == 0) {
                                // console.log('此时5G网络已关闭');
                                // debugger;
                                meshModeDialog = $.dialog({
                                    title: false,
                                    content: $('#tmplMeshMode').html(),
                                    padding: '30px 40px',
                                    lock: true,
                                    width: 400
                                });

                                $('#mesh-Off-5G').siblings('.switch-step').hide();
                                $('#mesh-Off-5G').show();


                            } else {
                                //console.log('此时5G网络已打开');
                                $.ajax({
                                    url: apiDevicesGet,
                                    type: 'GET',
                                    datatype: 'json',
                                    data: {},
                                    async: true,
                                    success: function (rsp) {

                                        rsp = $.parseJSON(rsp);
                                        isClick = false;

                                        // rsp = {"mac":"F8:FF:C2:67:93:90",
                                        //     "list":[
                                        //         {"mac":"8C:53:C3:B6:DE:F6","oname":"","isap":0,"parent":"","authority":{"wan":1,"pridisk":0,"admin":1,"lan":1},"push":0,"online":1,"name":"8C:53:C3:B6:DE:F6","times":0,"ip":[{"downspeed":"0","online":"37795","active":1,"upspeed":"15","ip":"192.168.31.97"}],"statistics":{"downspeed":"0","online":"37795","upspeed":"15"},"icon":"","type":1},
                                        //         {"mac":"F8:FF:C2:67:93:90","oname":"liuyutongdeMBP","isap":0,"parent":"C6:53:77:ED:5A:51","authority":{"wan":1,"pridisk":0,"admin":1,"lan":1},"push":0,"online":1,"name":"liuyutongdeMBP","times":0,"ip":[{"downspeed":"41","online":"5706","active":1,"upspeed":"0","ip":"192.168.31.102"}],"statistics":{"downspeed":"41","online":"5706","upspeed":"0"},"icon":"","type":2},
                                        //         {"mac":"F0:18:98:83:5C:77","oname":"jgdeMBP-7","isap":8,"parent":"","authority":{"wan":1,"pridisk":0,"admin":1,"lan":1},"push":0,"online":1,"name":"jgdeMBP-7","times":0,"ip":[{"downspeed":"423","online":"76131","active":1,"upspeed":"121","ip":"192.168.31.232"}],"statistics":{"downspeed":"423","online":"76131","upspeed":"121"},"icon":"device_list_apple.png","type":2},
                                        //         {"mac":"66:36:17:CA:CE:C5","oname":"","isap":8,"parent":"","authority":{"wan":1,"pridisk":0,"admin":1,"lan":1},"push":0,"online":1,"name":"66:36:17:CA:CE:C5","times":0,"ip":[{"downspeed":"0","online":"79664","active":1,"upspeed":"0","ip":"192.168.31.76"}],"statistics":{"downspeed":"0","online":"79664","upspeed":"0"},"icon":"","type":0},
                                        //         {"mac":"C6:53:77:ED:5A:51","oname":"MiWiFi-RM1800","isap":8,"parent":"","authority":{"wan":1,"pridisk":0,"admin":1,"lan":1},"push":0,"online":1,"name":"MiWiFi-RM1800","times":0,"ip":[{"downspeed":"0","online":"88932","active":1,"upspeed":"0","ip":"192.168.31.31"}],"statistics":{"downspeed":"0","online":"88932","upspeed":"0"},"icon":"","type":0}],"code":0}
                                        //
                                        // rsp = {"show":0,
                                        //     "graph":{"locale":"家","ssid":"Redmi_9452_FBAD","name":"Redmi_9452_FBAD","channel":"release","hardware":"RM1800","mode":0,"color":100,"ip":"192.168.31.1"},"code":0}
                                        // rsp = {
                                        //     "show": 1,
                                        //     "graph": {
                                        //         "ssid": "Redmi_9452_FBAD",
                                        //         "color": 100,
                                        //         "ip": "192.168.31.1",
                                        //         "locale": "家",
                                        //         "name": "Redmi_9452_FBAD",
                                        //         "channel": "release",
                                        //         "hardware": "RM1800",
                                        //         "mode": 0,
                                        //         "leafs": [
                                        //             {
                                        //             "ssid": "Redmi_9452_FBAD_5G",
                                        //             "color": 100,
                                        //             "ip": "192.168.31.6",
                                        //             "locale": "客厅",
                                        //             "name": "Redmi_9459_FBA6",
                                        //             "channel": "release",
                                        //             "hardware": "RM1800",
                                        //             "mode": 8,
                                        //             "version": ""
                                        //         },
                                        //             {
                                        //                 "ssid": "Redmi_9452_FBAD_5G",
                                        //                 "color": 100,
                                        //                 "ip": "192.168.31.6",
                                        //                 "locale": "客厅",
                                        //                 "name": "Redmi_9459_FBA6",
                                        //                 "channel": "release",
                                        //                 "hardware": "RM1800",
                                        //                 "mode": 8,
                                        //                 "version": ""
                                        //             }
                                        //         ]
                                        //     },
                                        //     "code": 0
                                        // }
                                        if (rsp.code === 0) {
                                            //取到devicelist中list数组
                                            //  console.log(rsp.list);
                                            var count = 0;
                                            var maxMeshCount =9;
                                            //获取已添加Mesh组网设备数量
                                            if (rsp.graph.renumber) {
                                                count = rsp.graph.renumber
                                            }
                                            // debugger;
                                            // console.log(count);

                                            meshModeDialog = $.dialog({
                                                title: false,
                                                content: $('#tmplMeshMode').html(),
                                                padding: '30px 30px',
                                                lock: true,
                                                width: 600,
                                            });

                                            // 设置最多只能添加九个路由器（新）

                                            if (count >= maxMeshCount) {

                                                $('#mesh-overMaxLength').siblings('.switch-step').hide();
                                                $('#mesh-overMaxLength').show();


                                            } else {

                                                $('#mesh-select').siblings('.switch-step').hide();
                                                $('#mesh-select').show();

                                            }

                                        }

                                    }
                                })
                            }


                        }

                    })
                    }
            });

            });
            $('body').delegate('#mesh_re_try', 'click', function (e) {
                e.preventDefault();
                $('#mesh-add-loading').siblings('.switch-step').hide();
                $('#mesh-add-loading').show();
            });

            //设置5G网络打开，跳转至常用设置页面
            $('body').delegate('#setting-5G-button', 'click', function (e) {
                e.preventDefault();
                window.location.href = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/web/setting/wifi'
            });


            $('body').delegate('#mesh_search_cancle,#mesh_add_success,#mesh-close-button,#setting-5G-button', 'click', function (e) {

                e.preventDefault();
                if(isStopSearch) {
                  isStopSearch.abort(); //停止搜索节点请求 接口scan_mesh_node
                }
                clearTimeout(timeout);
                $('#mesh-select,#mesh-search-lists,#mesh-overMaxLength,#mesh-search-loading,#mesh_list_length0,#mesh-add-success,#mesh-add-failer,#mesh-local,#mesh-Off-5G,#mesh-add-loading').hide();
                meshModeDialog.close();
            });

            //点击关闭按钮关闭定时器
            $('body').delegate('.panel span.d-close','click',function(e){
                // debugger;
                if(isStopSearch) {
                  isStopSearch.abort();//停止搜索节点请求 接口scan_mesh_node
                }
                clearTimeout(timeout);

            })
            $('body').delegate('#show_locate_select', 'click', function (e) {
                e.preventDefault();

                var iteValue = $('.list_box').find(".selected").attr("data-mac");

                if (iteValue) {
                    $('#mesh-local').siblings('.switch-step').hide();
                    $('#mesh-local').show();
                } else {
                    $.alert('Select the device to add');
                }

            });

            var timeout ;
            $('body').delegate('#mesh_search_add,#mesh_re_try', 'click', function (e) {
                e.preventDefault();

                var iteValue = $('.list_box').find(".selected").attr("data-mac");
                //开始添加子节点  api/xqnetwork/add_mesh_node
                var localValue = $("#locateSelect").find("option:selected").val();
                if (iteValue) {

                    // $('#mesh-search-lists').hide();
                    $('#mesh-add-loading').siblings('.switch-step').hide();
                    $('#mesh-add-loading').show();
                    // $('#mesh-local').hide();


                    var api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetwork/add_mesh_node';
                    $.post(api, {mac: iteValue, locate: localValue}, function (rsp) {
                        rsp = $.parseJSON(rsp);
                        // rsp = {
                        //     "code": 0,
                        //     "status": 4
                        // };
                        // 0:添加成功； 1：正在连接mesh节点  2：正在同步Mesh网络配置  3：正在扩展Mesh网络  4：失败

                        if (rsp.code == 0) {
                            setTimeout(function () {
                                getMeshStatus(iteValue);
                            }, 10000)
                        }
                    })
                }


            });


            function getMeshStatus(iteValue) {
                //轮询获取添加子节点状态  api/xqnetwork/get_addnode_status
                var api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetwork/get_addnode_status';
                $.get(api, {mac: iteValue}, function (rsp) {
                    rsp = $.parseJSON(rsp);
                    // 0:添加成功； 1：正在连接mesh节点  2：正在同步Mesh网络配置  3：正在扩展Mesh网络  4：失败
                    // rsp = {"status":3,"code":0}
                    if (rsp.code == 0) {
                        if (rsp.status == 0) {

                            $('#mesh-add-success').siblings('.switch-step').hide();
                            $('#mesh-add-success').show();

                        } else if (rsp.status == 4) {

                            $('#mesh-add-failer').siblings('.switch-step').hide();
                            $('#mesh-add-failer').show();

                        } else {
                            if (rsp.status === 3) {
                                $('#mesh-add-loading').find('p').html('Extending the Mesh network (approximately 1 minute)')
                            } else if (rsp.status === 2) {
                                $('#mesh-add-loading').find('p').html('Synchronizing the Mesh network configuration')
                            }
                            timeout =  setTimeout(function () {
                                getMeshStatus(iteValue);
                            }, 10000)

                        }

                    }
                })

            }

            var isStopSearch ;
            $('body').delegate('#mesh_search ,#mesh_re_search,#mesh-research-btn', 'click', function (e) {
                e.preventDefault();
                // $('#mesh-select').hide();
                //隐藏 选择要添加的设备 的弹窗
                // $('#mesh-search-lists').hide();

                $('#mesh-search-loading').siblings('.switch-step').hide();
                $('#mesh-search-loading').show();
                // $('#mesh_list_length0').hide();
                $('.d-hd').html('搜索并添加Mesh节点');
                //获取可添加的Mesh子节点 /api/xqnetwork/scan_mesh_node
                var api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetwork/scan_mesh_node';
                // debugger;
                isStopSearch = $.get(api, function (rsp) {
                    rsp = $.parseJSON(rsp);
                    // var rsp  = {
                    //     code:0,
                    //     list:[
                    //         {mac: "37:45:25:16:23:44", rssi: -35, ssid: "Redmi_9487_FB78", model: "RM1800"},
                    //         {mac: "37:45:25:16:23:44", rssi: -78, ssid: "Redmi_94bb_FB78", model: "RM1350"},
                            // {mac: "37:45:25:16:23:44", rssi: -78, ssid: "Redmi_94bb_FB78", model: "RM1350"},
                            // {mac: "37:45:25:16:23:44", rssi: -78, ssid: "Redmi_94bb_FB78", model: "RM1350"},
                            // {mac: "37:45:25:16:23:44", rssi: -78, ssid: "Redmi_94bb_FB78", model: "RM1350"},
                            // {mac: "37:45:25:16:23:44", rssi: -78, ssid: "Redmi_94bb_FB78", model: "RM1350"}
                    //     ]
                    // }

                    if (rsp.code == 0) {
                        // debugger;

                        if (rsp.list.length > 0) {
                            $.selectBeautify({
                                'maxHeight': '205px'
                            });


                            var select = $('.list_box');
                            select.html('');//添加之前清空列表，防止重复添加
                            var list = rsp.list;


                            $(list).each(function (index, item) {
                                var div = $('<div class=' + (list.length === 1 ? '"mesh_item selected"' : '"mesh_item"') + '>');
                                div.attr('data-ssid', StringH.encode4Html(item.ssid));
                                div.attr('data-mac', StringH.encode4Html(item.mac));
                                var rssi = item.rssi < -60 ? '<div class="rssi small"></div>' : '<div class="rssi"></div>';
                                var name = '<div class="name">' + StringH.encode4Html(item.ssid) + '</div>';
                                var mac = '<div class="mac">' + StringH.encode4Html(item.mac) + (item.rssi < -60 ? '<span>Signal is poor, please place the router near the central access point</span>' : '') + '</div>';
                                div.on('click', function () {
                                    $('.list_box').find('.mesh_item').removeClass('selected')
                                    $(this).addClass('selected');
                                });

                                div.append(rssi).append(name).append(mac)
                                select.append(div);
                            });
                            $('#mesh-search-lists').siblings('.switch-step').hide();
                            $('#mesh-search-lists').show();
                        } else {
                            //  debugger;
                            $('#mesh_list_length0').siblings('.switch-step').hide();
                            $('#mesh_list_length0').show();
                            $('.d-hd').html('No usable Mesh node found');

                        }





                        $('#mesh-search-loading').hide();

                    } else {
                        alert(rsp.msg);
                    }
                });

            })


            // user logined and has global header get notice
            if (typeof (GLOBALHEADER) !== 'undefined' && GLOBALHEADER === true) {
                getNotice();
            }
        });
    })(jQuery);
</script>
<script src="/js/miwifi-monitor.js"></script>
<script>
    // 流量统计
    (function () {
        var IS_MOBILE = (
            navigator.userAgent.match(/Android/i)
            || navigator.userAgent.match(/webOS/i)
            || navigator.userAgent.match(/iPhone/i)
            || navigator.userAgent.match(/iPad/i)
            || navigator.userAgent.match(/iPod/i)
            || navigator.userAgent.match(/BlackBerry/i)
            || navigator.userAgent.match(/Windows Phone/i)
        );
        var PAGEURL = document.URL.split('/web/')[1];
        var PAGE_MONITOR_CONF = {
            deviceId: '9081ca09-59a4-a807-f298-744f173aa202',
            isMobile: IS_MOBILE ? IS_MOBILE[0] : 'pc',
            url: PAGEURL ? '/web/' + PAGEURL : '/web/login',
            romVersion: '1.0.83',
            romChannel: 'release',
            hardwareVersion: 'RB01'
        };

        //默认URL配置，并启用鼠标点击和按键统计
        MIWIFI_MONITOR.setConf({
            trackUrl: 'http://sg.api.miwifi.com/res_stat/track.gif',
            clickUrl: 'http://sg.api.miwifi.com/res_stat/click.gif',
            wpoUrl: ''
        });

        MIWIFI_MONITOR.setProject('MIWIFIWEB');
        MIWIFI_MONITOR.log(PAGE_MONITOR_CONF, 'track');

        $(document).ajaxSend(function (event, jqxhr, settings) {
            var apiUrl = settings.url.split('/api/')[1],
                api = '/api/' + apiUrl.split('?')[0],
                apiParams = StringH.queryUrl(apiUrl);

            // console.log(apiUrl, api, apiParams);

            var API_MONITOR_CONF = ObjectH.mix({element: 'apicall', api: api}, [PAGE_MONITOR_CONF, apiParams]);
            // console.log(API_MONITOR_CONF);
            MIWIFI_MONITOR.log(API_MONITOR_CONF);
        });
    }());
</script>

<script type="tmpl/text" id="tmplSpeedTesting">
<div class="mod-speed-testing">
    <i class="ico-speed-testing"></i>
    <p>Testing connection speed…</p>
    <div class="loading"></div>
</div>
</script>
<script type="tmpl/text" id="tmplSpeedTestNorst">
<div class="mod-speed-testing">
    <i class="ico-speed-test"></i>
    <p>Hasn&#39;t been tested</p>
    <div class="btns">
        <a href="#" class="btn btn-primary" id="btnSpeedReTest"><span>Test</span></a>
    </div>
</div>
</script>
<script type="tmpl/text" id="tmplSpeedTestErr">
<div class="mod-speed-testing">
    <i class="ico-speed-test-err"></i>
    <p>Couldn&#39;t test network speed</p>
    <div class="btns">
        <a href="#" class="btn btn-primary" id="btnSpeedReTest"><span>Test again</span></a>
    </div>
</div>
</script>
<script type="tmpl/text" id="tmplBandTestErr">
<div class="mod-speed-testing">
    <i class="ico-speed-test-err"></i>
    <p>Couldn&#39;t test network speed</p>
    <div class="btns">
        <a href="#" class="btn btn-primary" id="btnBandReTest"><span>Test again</span></a>
    </div>
</div>
</script>
<script type="tmpl/text" id="tmplSpeedResult">
<div class="mod-speed-result">
    <ul class="clearfix">
        <li class="first">
            <i class="ico-speed"></i>
            <span class="num">{$speed}</span>
            <span class="con">
                {$unit}<br>
                {$type}
            </span>
        </li>
        <li>
            <span class="num">{$bandwidth}</span>
            <span class="con">
                Mbps<br>
                Internet bandwidth
            </span>
        </li>
    </ul>
    <div class="btns">
        <a id="btnSpeedReTest" href="#" class="btn btn-primary"><span>Test again</span></a>
        <a href="#" class="btn btn-primary" id="btnSpeedClose"><span>Done</span></a>
        <div class="manual">The speed is not accurate?<a id="manSet" href="#"  data-upband="{$upband}" data-downband="{$downband}">Add manually</a></div>
    </div>
</div>
</script>
<script type="tmpl/text" id="tmplBandResult">
<div class="mod-speed-result">
    <ul class="clearfix">
        <li class="first">
            <span class="num">{$upband}</span>
            <span class="con">
                Mbps<br>
                Upload bandwidth
            </span>
        </li>
        <li>
            <span class="num">{$downband}</span>
            <span class="con">
                Mbps<br>
                Download bandwidth
            </span>
        </li>
    </ul>
    <div class="btns">
        <a href="#" class="btn btn-primary btn-m" id="btnBandClose"><span>Done</span></a>
        <a id="btnBandReTest" href="#" class="btn btn-primary btn-m"><span>Test again</span></a>
        <div class="manual">The speed is not accurate?<a id="manSet" href="#"  data-upband="{$upband}" data-downband="{$downband}">Add manually</a></div>

    </div>
</div>
</script>
<script type="tmpl/text" id="tmplBandResult2">
<div class="mod-speed-result">
    <ul class="clearfix">
        <li class="first">
            <span class="num" id="outband-up">{$upband}</span>
            <span class="con">
                MB/s<br>
                Maximum upload speed
            </span>
        </li>
        <li>
            <span class="num" id="outband-down">{$downband}</span>
            <span class="con">
               MB/s<br>
                Maximum download speed
            </span>
        </li>
    </ul>
    <div class="btns">
         <a href="#" id="btnBandset" class="btn btn-dft btn-m" data-upband="{$upband*8}" data-downband="{$downband*8}"><span>Bandwidth limit settings</span></a>
    </div>
</div>
</script>

<script type="tmpl/html" id="tplbandsetform">
<div class="speedset" id="customset">
    <form action="/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/set_band" class="form form-horizontal form-qos" name="bandwidth" id="bandwidth" method="post">
        <input type="hidden" name="manual" value="1">
        <div class="form-item">
            <label class="k">Upload</label>
            <span class="v"><input type="text" name="upload" reqMsg="Upload bandwidth" datatype="n-6.2" minValue="0.01" maxValue="1024" class="ipt-text" value="{$upband}"></span>
            <em class="t">Mbps</em>
        </div>
        <div class="form-item">
            <label class="k">Download</label>
            <span class="v"><input type="text" name="download" reqMsg="Download bandwidth" datatype="n-6.2" minValue="8" maxValue="2048" class="ipt-text" value="{$downband}"></span>
            <em class="t">Mbps</em>
        </div>
        <div class="form-contral">
            <button type="submit" id="submitbandwirdh" class="btn btn-primary btn-l"><span>OK</span></button>
        </div>
    </form>
</div>
</script>
<script>
(function( $ ){

    var dlgSpeed = {},isSpeedTest = 0;
    var getDownloadSpeed = function(){
        var dtd = $.Deferred();
        $.ajax({
            url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/bandwidth_test',
            type: 'POST',
            data: { 'new': 1 },
            dataType: 'json',
            success: function( rsp ){
                if ( rsp.code == 0 ) {
                     dtd.resolve( rsp );
                } else {
                     dtd.reject();
                }
            },
            error: function(){
                dtd.reject();
            }
        });
        return dtd.promise();
    };
    var getUploadSpeed = function(){
        var dtd = $.Deferred();
        $.ajax({
            url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetdetect/netupspeed',
            type: 'POST',
            data: {},
            dataType: 'json',
            success: function( rsp ){
                if ( rsp.code == 0 ) {
                     dtd.resolve( rsp );
                } else {
                     dtd.reject();
                }
            },
            error: function(){
                dtd.reject();
            }
        });
        return dtd.promise();
    };
    var setQosband = function( upload, download ){
        var dtd = $.Deferred();
        $.ajax({
            url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/set_band',
            type: 'POST',
            data: { upload: upload, download: download },
            dataType: 'json',
            success: function( rsp ){
                if ( rsp.code == 0 ) {
                     dtd.resolve( rsp );
                } else {
                     dtd.reject();
                }
            },
            error: function(){
                dtd.reject();
            }
        });
        return dtd.promise();
    };
    var speedTest = function(){
        var dtd = $.Deferred();
        var downspeed, downband, upspeed, upband;
        var testerror = function(){
            dlgSpeed.content( $('#tmplSpeedTestErr').html() );
            dtd.reject();
        };
        var downtestdone = function( rsp ){
            downband = rsp.bandwidth;
            downspeed = rsp.download;
            upband = rsp.bandwidth2;
            upspeed = rsp.upload;
        };
        var uptestdone = function( rsp ){
            upband = rsp.bandwidth;
            upspeed = rsp.upload;
        };
        var setbanddone = function( rsp ){
            dtd.resolve( downband, upband, downspeed, upspeed );
        };
        // start down speed test
        getDownloadSpeed()
        .then( function( rsp ){
            downtestdone.call( null, rsp );
        }, testerror )
        // .then( function( rsp ){
        //     uptestdone.call( null, rsp );
        //     return setQosband( upband, downband );
        // }, testerror )
        .then( function( rsp ){
            setbanddone.call( null, rsp );
        }, testerror );

        return dtd.promise();
    };

    $.sub( 'speed:test', function( evt, data ){
        var dlg = data.dlg,
            ishistory = data.ishistory || false,
            downloadspeed,
            strdownspeed,
            unit,
            bandwidth,
            speedresult,
            tpl = $( '#tmplSpeedResult' ).html(),
            testType = ishistory ? 'Previous speed': 'Internet speed';
        dlgSpeed.testPadding = true;

        var showErr = function(){
            dlg.content( $( '#tmplSpeedTestErr' ).html() );
        };
        var showRsp = function( rsp ){
            if ( rsp.code === 0 ) {
                downloadspeed = parseFloat( rsp.download );
                if ( downloadspeed > 1024 ) {
                    unit = 'MB/S';
                    strdownspeed = downloadspeed / 1024;
                } else {
                    unit = 'KB/S';
                    strdownspeed = downloadspeed;
                }
                bandwidth = parseFloat( rsp.bandwidth );
                if ( rsp.bandwidth > 0 ) {
                    dlg.content( tpl.tmpl( {
                        speed: strdownspeed.toFixed(2),
                        unit: unit,
                        bandwidth: bandwidth.toFixed(2),
                        type: testType
                    } ) );
                } else {
                    dlg.content( $( '#tmplSpeedTestNorst' ).html() );
                }
                if ( !ishistory ) {
                    dlgSpeed.needreload = true;
                }
            } else {
                showErr();
            }
        };
        if ( ishistory ) {
            $.ajax({
                url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/bandwidth_test',
                type: 'POST',
                dataType: 'json',
                data: {history: 1 }
            }).done(function( rsp ){
                showRsp.call( null , rsp );
                dlgSpeed.testPadding = false;
            }).fail(function(){
                showErr();
                dlgSpeed.testPadding = false;
            });
        } else {
            $.when( speedTest() )
            .done(function( downband, upband, downspeed, upspeed ){
                if (manual == 0 ) {
                    downband == "--";
                    downspeed = "--";
                    upspeed = "--";
                    $('#testBand').text("Start speed test");
                }
                showRsp.call( null , {
                    code: 0,
                    download: downspeed,
                    bandwidth: downband
                } );
                dlgSpeed.testPadding = false;
            })
            .fail(function(){
                showErr();
                dlgSpeed.testPadding = false;
            });
        }
    } );

    // set bandwidth form callback
    function setBandWidth( e ){
        e.preventDefault();
        var tar = e.target,
            formName = tar.name,
            requestURL = tar.action,
            requestData = $(tar).serialize(),
            validate = Valid.checkAll( $('#bandwidth')[0] );

        if ( validate ) {
            $.pub('loading:start');
            $.ajax({
                url: requestURL,
                data: requestData,
                type: 'POST',
                dataType: 'json'
            })
            .done(function( rsp ){
                if ( rsp.code === 0 ) {
                    if (dlgSpeed && dlgSpeed.options && dlgSpeed.options.qostestok) {
                        dlgSpeed.options.qostestok();
                    }else {
                        location.reload( 1 );
                    }
                } else {
                    $.alert( rsp.msg );
                }
                $.pub('loading:stop');
            });
        }
    }
    $.sub( 'qos:test', function( evt , data){
        var requestURL = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/bandwidth_test',
            requestData = {history:1};
            if (data.st) {
                 $.getJSON( requestURL, requestData, function( rsp ){
                    if ( rsp.code == 0 ) {
                            if (rsp.manual === 0) {
                                dlgSpeed = $.dialog({
                                    title: 'Set network bandwidth manually',
                                    content: $('#tplbandsetform').html().tmpl({
                                        upband: "",
                                        downband: ""
                                    }),
                                    lock: true,
                                    qostestok: function(){
                                         data.cb();
                                     }

                                    });
                                setTimeout(function(){
                                    $.formInit();
                                }, 100);
                             }else {
                                 data.cb();
                    }
                }
            });

            }else {
                 data.cb();
            }
       
            });

    $.sub( 'band:test', function( evt , data ){
        var dlg = data.dlg,
            tpl = $( '#tmplBandResult' ).html(),
            tpl2 = $( '#tmplBandResult2' ).html();
        var showRsp = function( downband, upband, downspeed, upspeed ){
            var result = tpl.tmpl( {
                downband: downband,
                upband: upband
            } );
            var result2 = tpl2.tmpl( {
                downband: downband,
                upband: upband
            } );
            dlg.content( result );
            $('#speedresult').html( result2 );
        };
        var showErr = function(){
            dlg.content( $( '#tmplBandTestErr' ).html() );
        };
        dlgSpeed.testPadding = true;
        $.when( speedTest() )
            .done(function( downband, upband, downspeed, upspeed ){
                showRsp.apply( null , [downband, upband, downspeed, upspeed] );
                dlgSpeed.testPadding = false;
                dlgSpeed.needreload = true;
            })
            .fail(function(){
                showErr();
                dlgSpeed.testPadding = false;
            });
    } );

    $.sub( 'speed:history', function(){
        var requestURL = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/bandwidth_test',
            requestData = { history: 1 };
        $.getJSON( requestURL, requestData, function( rsp ){
            if ( rsp.code == 0 ) {
                var unit = 'KB/S';
                var speed = parseFloat( rsp.download );
                var bandwidth = parseFloat( rsp.bandwidth );
                var bandwidth2 = parseFloat( rsp.bandwidth2 );
                var strbw,statusInternet,bandwidthval,bandwidth2val;
                if (bandwidth === 0) {
                    strbw = '--';
                    bandwidthval = "--";
                    bandwidth2val = "--";
                    statusInternet = "Set up broadband";
                    // $('#retestSpeed').text("Start speed test");
                    $('#manualSetting').text("Add manually");
                } else {
                    isSpeedTest = 1;
                    strbw = bandwidth.toFixed(2);
                    bandwidthval = bandwidth.toFixed(2);
                    statusInternet = "Bandwidth<b class=bandwidthval>"+bandwidthval+"</b>M";
                    bandwidth2val = bandwidth2.toFixed(2);
                }
                if ( speed > 1024 ) {
                    unit = 'MB/S';
                    speed = speed / 1024;
                }
                // $( '#maxSpeed' ).html( speed );
                // $( '#maxSpeedunit' ).html( unit );
                // $( '#downloadspeed' ).html( speed );
                // $( '#downloadspeedunit' ).html( unit );
                $( '.bandwidthval' ).text( strbw );
                $( '#banddownload' ).text( bandwidthval );
                $('#statusInternet').html( statusInternet );
                $( '#bandupload' ).text( bandwidth2val );
                $( '#btnBandset' ).attr('data-upband', bandwidth2.toFixed(2)).attr('data-downband', bandwidth.toFixed(2));
            }
        } );
    } );

    $(function(){
        $( '#btnSpeedTest' ).on( 'click', function( e ){
            e.preventDefault();
            dlgSpeed = $.dialog({
                title: 'Network speed',
                width: 900,
                content: $( '#tmplSpeedTesting' ).html(),
                lock: true,
                padding: 0,
                beforeunload: function(){
                    if ( dlgSpeed.testPadding ) {
                        alert('Testing…');
                        return false;
                    }
                    if ( dlgSpeed.needreload ) {
                        $.pub( 'speed:history' );
                    }
                }
            });

            // $.pub( 'speed:test', {dlg: dlgSpeed} );
            $.pub( 'band:test', {dlg: dlgSpeed} );

        } );

        $( 'body' ).delegate( '.btnBandTest', 'click', function( e ){
            e.preventDefault();
            dlgSpeed = $.dialog({
                title: 'Test internet bandwidth',
                width: 900,
                content: $( '#tmplSpeedTesting' ).html(),
                lock: true,
                padding: 0,
                beforeunload: function(){
                    if ( dlgSpeed.testPadding ) {
                        alert('Testing…');
                        return false;
                    }
                    if ( dlgSpeed.needreload ) {
                        window.top.location.reload( 1 );
                    }
                }
            });

            $.pub( 'band:test', {dlg: dlgSpeed} );

        } );

        $( 'body' ).delegate( '#btnSpeedReTest', 'click', function( e ){
            e.preventDefault();
            dlgSpeed.content( $( '#tmplSpeedTesting' ).html() );
            $.pub( 'speed:test', {dlg: dlgSpeed} );
        } );

        $( 'body' ).delegate( '#btnSpeedClose', 'click', function( e ){
            e.preventDefault();
            dlgSpeed.close();
        } );

        $( 'body' ).delegate( '#btnBandReTest', 'click', function( e ){
            e.preventDefault();
            dlgSpeed.content( $( '#tmplSpeedTesting' ).html() );
            $.pub( 'band:test', {dlg: dlgSpeed} );
        } );

        $( 'body' ).delegate( '#btnBandClose', 'click', function( e ){
            e.preventDefault();
              if (dlgSpeed && dlgSpeed.options && dlgSpeed.options.qostestok) {
                dlgSpeed.options.qostestok();
            }
            dlgSpeed.close();
        } );

        $( 'body' ).delegate( '.get-history-speed', 'click', function( e ){
            e.preventDefault();
            dlgSpeed = $.dialog({
                title: 'Network speed',
                width: 900,
                content: '<div class="mod-speed-testing">Just a sec…</div>',
                lock: true,
                padding: 0,
                beforeunload: function(){
                    if ( dlgSpeed.testPadding ) {
                        alert('Testing…');
                        return false;
                    }
                    if ( dlgSpeed.needreload ) {
                        $.pub( 'speed:history' );
                    }
                }
            });
            $.pub( 'speed:test', {dlg: dlgSpeed, ishistory: true} );
        } );

        $('body').delegate( '#btnBandset', 'click', function( e ){
            e.preventDefault();
            var upband = $(this).attr('data-upband'),
                downband = $(this).attr('data-downband');
            dlgSpeed = $.dialog({
                title: 'Set network bandwidth manually',
                content: $('#tplbandsetform').html().tmpl({
                    upband: upband,
                    downband: downband
                }),
                lock: true
            });
            setTimeout(function(){
                $.formInit();
            }, 100);
        });

          $('body').delegate( '#manSet', 'click', function( e ){
            e.preventDefault();
            var upband = $(this).attr('data-upband'),
                downband = $(this).attr('data-downband'),
                upbandTxt,
                downbandTxt;
                if (downband == 0) {
                    upbandTxt = downbandTxt ="";

                }else {
                    upbandTxt = upband;
                    downbandTxt = downband;
                }
            $.dialog({
                title: 'Set network bandwidth manually',
                content: $('#tplbandsetform').html().tmpl({
                    upband: upbandTxt,
                    downband: downbandTxt
                }),
                lock: true
            });
            setTimeout(function(){
                $.formInit();
            }, 100);
        });

        $( 'body' ).delegate( '#bandwidth', 'submit', setBandWidth );
    });
})(jQuery);
</script>

<script src="/xiaoqiang/web/js/class.linechart.js"></script>
<script src="/xiaoqiang/web/js/class.pie.js"></script>
<script>
// net diagnisis
var hardware = 'rb01',aysyc;
    if (hardware == 'r1cm' || hardware == 'r1cl' || hardware =='r3' || hardware =='r3a' || hardware =='r3l' || hardware =='r4c' || hardware =='r4cm' || hardware =='r4ac') {
        aysyc = false;
    }else {
        aysyc = true;
    }
var isMeshShow = false;   
$.sub('netdiagnosis', function(){
    var apiNettb = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetdetect/nettb';
    var devline = document.getElementById('devline');
    var netline = document.getElementById('netline');
        $.ajax({
            url: apiNettb,
            type: 'GET',
            datatype: 'json',
            async: aysyc,
            success: function( rsp ){
            rsp = $.parseJSON(rsp);
            if ( rsp.code == 0 ) {
                if ( rsp.error == 0 ) {
                    devline.className = 'line line-ok';
                    netline.className = 'line line-ok';
                } else {
                    devline.className = 'line line-ok';
                    netline.className = 'line line-err';
                    $(netline)
                    .attr('title', 'Tap to test network')
                    .click(function(){
                       if (/;stok=/.test(location.href))
                       {
                         var token = location.href.match(/;stok=([^/]*)\//)[1];
                         window.location.href = window.location.origin + '/cgi-bin/luci/;stok=' + token + '/diagnosis';
                       }
                      else
                      {
                        window.location.href = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/diagnosis';
                      }
                    });
                }
            }
    }
    });
    
});

// get devices
$.sub( 'devices:getlist', function( evt, data ){
    var apiDevicesGet = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/devicelist',
        apiDevicesGetData = {},
        macLocal,
        tplItem = $( '#tmpldevicesitem' ).html(),
        tplWaper = $('#tmpldeviceswrap').html(),
        wraper = $('#devicesTables'),
        devices,
        deviceslistHtml = [],
        listHtml = {
            '0': [],
            '1': [],
            '2': [],
            '3': [],
            '4': []
        },
        hasDisk = G_FEATURES['hardware']['disk'] === '1',
        isWifi5G = G_FEATURES['wifi']['wifi50'] === '1';
        d_type_id = 0,
        //4 mesh主  8mesh子
        d_is_ap = 0;
     $.ajax({
            url: apiDevicesGet,
            type: 'GET',
            datatype: 'json',
            data: apiDevicesGetData,
            async: aysyc,
            success: function( rsp ){
             rsp =  $.parseJSON(rsp);   
        if ( rsp.code === 0 ) {
            devices = rsp.list;
            macLocal = rsp.mac.toUpperCase();
            if ( devices.length > 0 ) {
                for ( var i = 0 ; i < devices.length ; i++ ) {
                    var d_mac, d_self, d_ip, d_type, d_option, d_signal_level, d_action, d_action2, d_online, d_download, d_dld_speed, d_wan, d_lan, type_html, type_detail, d_html, d_activets,
                        d_devices_icon = '/img/device_list_unknow.png',
                        // 0/1/2/3  有线 / 2.4G wifi / 5G wifi / guest wifi
                        //这个地方加个返回一个 4 表示mesh
                        d_type_id,
                        d_is_ap,
                        d_name,
                        d_origin_name;
                    d_mac = devices[i].mac.toUpperCase();

                    d_type_id = d_type_id;
                    d_is_ap = d_is_ap;

                    if( $.isArray(devices[i].ip) ){
                        d_ip = $(devices[i].ip).map(function(){
                            //console.log(this);
                            return this.ip;
                        }).get();
                    } else {
                        d_ip = [];
                    }

                    d_type_id = devices[i].type;
                    d_name = devices[i].name;
                    d_origin_name = devices[i].oname;

                    d_wan = devices[i].authority.wan;
                    d_lan = devices[i].authority.lan;

                    d_is_ap = devices[i].isap;
                    //console.log(devices[i].isap);


                    if ( devices[i].statistics ) {
                        d_online = devices[i].statistics.online;
                        d_download = devices[i].statistics.download;
                        d_dld_speed = devices[i].statistics.downspeed;
                    }
                    if ( devices[i].icon && devices[i].icon !== "") {
                        d_devices_icon = '/cn/' + devices[i].icon;
                    }

                    if ( macLocal == d_mac ) {
                        d_self = true;
                    } else {
                        d_self = false;
                    }
                    //终端操作
                    var tplDevAction = '<a data-self="{$d_self}" data-mac="{$d_mac}" data-type="{$d_type}" href="#" class="btn-switch btn-switch-{$status} {$cls}"></a>';
                    if ( d_wan == 0 ) {
                        d_action = tplDevAction.tmpl({
                            'd_self': d_self ? '1':'0',
                            'd_mac': d_mac,
                            'd_type': 'wan',
                            'cls': 'act-add-back',
                            'status': 'off'
                        });
                    } else {
                        d_action = tplDevAction.tmpl({
                            'd_self': d_self ? '1':'0',
                            'd_mac': d_mac,
                            'd_type': 'wan',
                            'cls': 'act-kick-out',
                            'status': 'on'
                        });
                    }
                    if ( d_lan == 0 ) {
                         d_action2 = tplDevAction.tmpl({
                            'd_self': d_self ? '1':'0',
                            'd_mac': d_mac,
                            'd_type': 'lan',
                            'cls': 'act-add-back',
                            'status': 'off'
                        });
                    } else {
                        d_action2 = tplDevAction.tmpl({
                            'd_self': d_self ? '1':'0',
                            'd_mac': d_mac,
                            'd_type': 'lan',
                            'cls': 'act-kick-out',
                            'status': 'on'
                        });
                    }
                    if ( d_type_id == 3 ) {
                        d_action2 = '';
                    }
                    
                    d_html = tplItem.tmpl( {
                        'name' : StringH.encode4HtmlValue(d_name),
                        'origin_name' : d_origin_name,
                        'mac' : d_mac,
                        'devices_icon' : d_devices_icon,
                        'download' : byteFormat(d_download, 100),
                        'speed' : byteFormat(d_dld_speed, 100),
                        'online' : $.secondToDate(d_online),
                        'option' : d_action,
                        'option2' : d_action2,
                        'ip': d_ip,
                        'isself': d_self,
                        'd_type_id':d_type_id,
                        'd_is_ap':d_is_ap,
                        'hasDisk': hasDisk
                    } );

                    if(d_is_ap == 8){
                        d_type_id =4
                    }
                    

                    if(d_type_id ==4){
                        listHtml[0].push( d_html );
                    }else{
                        listHtml[d_type_id+1].push( d_html );
                    }
                    
                   
                }

                var containerList = [],
                    containerTitle = ['Mesh Networking Devices','Ethernet cable connected devices','Connected devices(2.4G)','Connected devices(5G)','Connected devices'];
                if (!isWifi5G) {
                    containerTitle = ['Mesh Networking Devices','Ethernet cable connected devices','Devices connected to Wi-Fi','Connected devices(5G)','Connected devices'];
                }

               
                console.log(listHtml);
                for (var key in listHtml) {
                    var devlen = listHtml[key].length,
                        devtype = containerTitle[key];
                    if ( devlen > 0 ) {
                        containerList.push(
                            tplWaper.tmpl({
                                devlen: devlen,
                                devtype: devtype,
                                deviceslist: listHtml[key].join(''),
                                hasDisk: hasDisk
                            })
                        );
                    } else {
                        if ( key == 3 && isWifi5G) {
                            containerList.push(
                                // tplWaper.tmpl({
                                //     devlen: devlen,
                                //     devtype: devtype,
                                //     deviceslist: $('#tmpldevices5gempty').html(),
                                //     hasDisk: hasDisk
                                // })
                            );
                        }
                    }
                }
                wraper.html( containerList.join('') );
                // mesh 屏蔽访问外网
                    //只有"Mesh组网"设备的情况下，并没有去掉访问外网，需要根据长度先判断下
                    var meshNet = 'Mesh Networking Devices'
                    if($('#devicesTables .mod-table-devices').siblings().length > 0){
                        if($('#devicesTables .mod-table-devices').siblings().first().find('.s0').text() == meshNet){
                            $('#devicesTables .mod-table-devices').siblings().first().find('.s1').html('');
                        }
                    }else{
                        if($('#devicesTables .mod-table-devices').find('.s0').text() == meshNet){
                            $('#devicesTables .mod-table-devices').find('.s1').html('');
                        }
                    }

            }
        }
    }
    } );
} );

//禁止上网
$.sub( 'devices:kick_out', function( evt, data ){
    var requestData = {};
    requestData['mac'] = data.mac;
    requestData[data.type] = 0;
    $.pub( 'loading:start' );
    $.ajax({
            url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/set_mac_filter',
            type: 'GET',
            datatype: 'json',
            data: requestData,
            async: aysyc,
            success: function( rsp ){
        $.pub( 'loading:stop' );
        rsp =  $.parseJSON(rsp);  
        if( rsp.code === 0 ){

            $.pub( 'devices:getlist'  );
        } else {
            $.alert( rsp.msg );
        }
    }
    } );
} );

//允许上网
$.sub( 'devices:add_back', function( evt, data ){
    var requestData = {};
    requestData['mac'] = data.mac;
    requestData[data.type] = 1;
    $.pub( 'loading:start' );
     $.ajax({
            url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqsystem/set_mac_filter',
            type: 'GET',
            datatype: 'json',
            data: requestData,
            async: aysyc,
            success: function( rsp ){
                $.pub( 'loading:stop' );
                rsp =  $.parseJSON(rsp);  
                if( rsp.code === 0 ){
                    $.pub( 'devices:getlist'  );
                } else {
                    $.alert( rsp.msg );
                }
    }
    } );
});
// devices event
$.sub('devices:addevent', function(){
    //禁止
    var actKickOut = $.debounce(function( e ){
        e.preventDefault();
        var mac = $(this).attr('data-mac');
        var type = $(this).attr('data-type');
        var self = $(this).attr('data-self') === '1';
        if ( self ) {
            var cfm = window.confirm('Remove this device?');
            if ( cfm ) {
                $(this).removeClass('btn-switch-on').addClass('btn-switch-off');
                $.pub( 'devices:kick_out', {'mac' : mac, 'type': type} );
                
            }
        } else {
            $.pub( 'devices:kick_out', {'mac' : mac, 'type': type} );
        }
    } , 300, true );
    $( 'body' ).delegate( '.act-kick-out', 'click', actKickOut);

    //允许
    var actKickBack = $.debounce(function( e ){
        e.preventDefault();
        var mac = $(this).attr('data-mac');
        var type = $(this).attr('data-type');
        $.pub( 'devices:add_back', {'mac' : mac, 'type': type} );
    } , 300, true );
    $( 'body' ).delegate( '.act-add-back', 'click', actKickBack);



    //eye click
    $( 'body' ).delegate( '.wifi_set ul li .eye2', 'click', function(){
        if( $(this).hasClass("show") ){
            $(this).removeClass("show");
            $(this).siblings('input[type=password]').show();
            $(this).siblings('input[type=text]').hide();
        }else{
            $(this).addClass("show");
            $(this).siblings('input[type=text]').show();
            $(this).siblings('input[type=password]').hide();
        }
    });

});

$.sub( 'wifi:get', function( evt, data ){
    var apiGetWiFi = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetwork/wifi_detail_all',
        apiGetWiFiData = {};
            $.ajax({
            url: apiGetWiFi,
            type: 'GET',
            datatype: 'json',
            data: apiGetWiFiData,
            async: aysyc,
            success: function( rsp ){
                rsp =  $.parseJSON(rsp);  
        if ( rsp.code === 0 ) {
            wifiInfo = rsp.info;
            var wifi24status = wifiInfo[0].status;
            var wifi50status = wifiInfo[1] && wifiInfo[1].status;
            var wifi24ssid = wifiInfo[0].ssid;
            var wifi50ssid = wifiInfo[1] && wifiInfo[1].ssid;
            $('#ssid24status')[0].className = wifi24status == 0 ? 'ico ico-wifi-off' : 'ico ico-wifi-on';
            $('#ssid50status')[0].className = wifi50status == 0 ? 'ico ico-wifi-off' : 'ico ico-wifi-on';
            $('#ssid24val').text(wifi24ssid);
            $('#ssid50val').text(wifi50ssid);
        }
    }
    });
        
} );

// 新加的 替换旧的status接口
$.sub('status:newget', function(){
   
    var mapChannel, mapModel;
    mapChannel = {
        'current': 'Beta',
        'release': 'Release',
        'stable': 'Beta'
    },
    mapModel = {
        'R1D': 'Mi Router',
        'R2D': 'Mi Router 2',
        'R3D': '小米路由器HD',
        'R1CM': 'Mi Router Mini',
        'R1CL': 'Mi Wi-Fi Nano',
        'R3': '小米路由器3',
        'R3L': '小米路由器3C',
        'R3P': '小米路由器3 Pro',
        'R3A': '小米路由器3A',
        'R3G': '小米路由器3G',
        'R4': 'Mi Wi-Fi 4',
        'R4C': '小米路由器4Q',
        'R4CM': 'Mi Wi-Fi 4C',
        'D01': '小米路由器Mesh',
        'R4AC': 'Mi Router 4A',
        'R4A': '小米路由器4 v2',
        'R3Gv2': '小米路由器3G',
        'R2600': '小米路由器2600',
        'R2100': '小米路由器AC2100',
        'R1500': '小米路由器1500',
        'R3600': '小米AIoT路由器 AX3600',
        'R1800': '小米AIoT路由器 AX1800',
        'RA72': '小米路由器 AX6000',
	'RA80': 'Mi Router AX3000',
	'RA81': 'Mi Router AX3000',
        'RA82': 'Mi Router AX3000',
        'RA83': 'Mi Router AX3000',
        'RB01': 'Xiaomi Router AX3200'
    };
    var apiNewStatus = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/newstatus';
    $.ajax({
                url: apiNewStatus,
                type: 'GET',
                datatype: 'json',
                success: function(res){
                    res =  $.parseJSON(res); 
                    if(res.code == 0){
                        //2.4g
                        $('.wifi_2g_name').html('Wi-Fi name：'+res['2g'].ssid);
                        if(res['2g'].pssswd != ''){
                            $('.wifi_2g_pssswd').val(res['2g'].pssswd);
                        }else{
                            $('.passwd_2g').html('Password: Not set');
                        }
                        $('.wifi_2g_online').html('Clients：'+res['2g'].online_sta_count);
                        //5g
                        $('.wifi_5g_name').html('Wi-Fi name：'+res['5g'].ssid);
                        if(res['5g'].passwd != ''){
                            $('.wifi_5g_pssswd').val(res['5g'].passwd);
                        }else{
                            $('.passwd_5g').html('Password: Not set');
                        }
                        $('.wifi_5g_online').html('Clients：'+res['5g'].online_sta_count);
                        //信息
                        
                        $('.routermodel').text(mapModel[res.hardware.platform]);
                    
                        $('.routerversion').text('MiWiFi ' + mapChannel[res.hardware.channel] + ' ' + res.hardware.version);
                        $('.routermac').text(res.hardware.mac);
                        $('.routersn').text(res.hardware.sn);
                        $('.devcountonline1').text(res.count);
                    }else{
                        $.alert(res.msg);
                    }
                }
            });
});

$.sub('status:get', function(){
    var apiSysstatus = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/status',
        apiSysstatusData = {};

    function getCpu( data ){
        $('#cpuused').text( (data.load * 100).toFixed(2) + '%' );
        $('#cpucore').text( data.core );
        $('#cpuhz').text( data.hz );
    }
    function getMem( data ){
        $('#memused').text( (data.usage * 100).toFixed(2) + '%' );
        $('#memtotal').text( data.total );
        $('#memhz').text( data.hz );
        $('#memtype').text( data.type );
    }
    function getDev(data){
        if(hardware=='d01'){
            //console.log(data)
            //累计终端
            $('#devcountall').text(data.all_without_mesh);
            //终端设备 当前终端
            $('.devcountonline1').text(data.devcountonline);
            $('.devcountonline2').text(data.online_without_mesh);
        }else{
            $('#devcountall').text(data.devcountall);
            $('.devcountonline').text(data.devcountonline);
        }
    }
    function getWan(data){
        $('.currentspeed').text( byteFormat( data.downspeed, 100) + '/S');
        $('.currentupspeed').text( byteFormat( data.upspeed, 100) + '/S')
        $('#maxdownloadspeed').text( byteFormat( data.maxdownloadspeed , 100) + '/S' );
        $('#downloadcount').text( byteFormat( data.download, 100 ) );
        $('#uploadcount').text( byteFormat( data.upload, 100 ) );
    }
    function getHardware(data){

        

        var mapChannel, mapModel;
        mapChannel = {
            'current': 'Beta',
            'release': 'Release',
            'stable': 'Beta'
        },
        mapModel = {
            'R1D': 'Mi Router',
            'R2D': 'Mi Router 2',
            'R3D': '小米路由器HD',
            'R1CM': 'Mi Router Mini',
            'R1CL': 'Mi Wi-Fi Nano',
            'R3': '小米路由器3',
            'R3L': '小米路由器3C',
            'R3P': '小米路由器3 Pro',
            'R3A': '小米路由器3A',
            'R3G': '小米路由器3G',
            'R4': 'Mi Wi-Fi 4',
            'R4C': '小米路由器4Q',
            'R4CM': 'Mi Wi-Fi 4C',
            'D01': '小米路由器Mesh',
            'R4AC': 'Mi Router 4A',
            'R4A': '小米路由器4 v2',
            'R3Gv2': '小米路由器3G',
            'R2600': '小米路由器2600',
            'R2100': '小米路由器2100',
            'R1500': '小米路由器1500',
            'R3600': '小米AIoT路由器 AX3600',
            'R1800': '小米AIoT路由器 AX1800',
            'RA72': '小米路由器 AX6000',
            'RA80': 'Mi Router AX3000',
            'RA81': 'Mi Router AX3000',
            'RA82': 'Mi Router AX3000',
            'RA83': 'Mi Router AX3000',
            'RB01': 'Xiaomi Router AX3200'
        };

        $('#routermodel').text(mapModel[data.platform]);
        $('#routerversion').text('MiWiFi ' + mapChannel[data.channel] + ' ' + data.version);
        $('#routermac').text(data.mac);
        $('#routersn').text(data.sn);
    }
    $.ajax({
            url: apiSysstatus,
            type: 'GET',
            datatype: 'json',
            data: apiSysstatusData,
            success: function( rsp ){
                rsp = JSON.parse(rsp);
                if ( rsp.code == 0 ) {

                    for(var i=0;i<rsp.dev.length;i++){
                        if(rsp.dev[i].isap == 8){
                            rsp.dev.splice(i,1);
                            i--;
                        }       
                    }

                    getCpu(rsp.cpu);
                    getMem(rsp.mem);
                    getDev({
                        devcountall: rsp.count.all,
                        devcountonline: rsp.count.online,
                        online_without_mesh:rsp.count.online_without_mash,
                        all_without_mesh:rsp.count.all_without_mash
                    });
                    getWan(rsp.wan);
                    getHardware(rsp.hardware)
                    //饼图
                    $.pub('chart:pie_update', {devStatistics: rsp.dev});
                    $.pub('chart:speedUpdate', rsp.wan);
                    $.pub('chart:cpuUpdate', rsp.cpu);
                    $.pub('chart:memUpdate', rsp.mem);
                }
            }
        });
});


//PPPoE checkstatus
$.sub('pppoeStatus', function(evt, data){
    time = data ? data.time : 0;
    timer = null;
    clearTimeout(timer);
    function ask(){
        $.ajax({
            url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqnetwork/pppoe_status',
            type: "GET",
            dataType: "json",
            async: aysyc,
            success : function(rsp){
                var msg,
                    ip = '-.-.-.-',
                    mask =  '-.-.-.-',
                    gateway =  '-.-.-.-',
                    dns = [],
                    action = '';
                if(rsp.proto == 'pppoe'){
                    switch(rsp.status){
                        case 1 :
                            msg = 'Dialing…';
                            timer = setTimeout(ask, 2000);
                            break;
                        case 2 :
                            msg = '拨号成功';
                            ip = rsp.ip['address'];
                            mask = rsp.ip['mask'];
                            gateway = rsp.gw;
                            dns = rsp.dns;
                            action = '<a id="pppoeStop" href="#">断开</a>';
                            break;
                        case 3 :
                            msg = rsp.msg || 'Couldn&#39;t dial';
                            msg = msg + ', trying special dial mode…';
                            timer = setTimeout(ask, 2000);
                            break;
                        case 4 :
                            msg = 'Disconnected';
                            action = '<a id="pppoeStart" href="#">Connect</a>';
                            // 断开后重新连接查询3次，防止拿不到底层新数据
                            if ( askcount < 4 ) {
                                timer = setTimeout(ask, 2000);
                            }
                            askcount ++;
                            break;
                        default:
                            break;
                    }
                    if ( $.isArray(dns)) {
                        dns = dns.join('<br>');
                    }
                    var statusHTML = StringH.tmpl( $('#tmplWaninfo').html(), {
                        wantype: 'PPPoE',
                        status: msg,
                        ip: ip,
                        mask: mask,
                        gateway: gateway,
                        dns: dns,
                        username: rsp.pppoename,
                        action: action
                    });

                    $( '#wanStatusContent' ).html( statusHTML );
                } else {
                    if ( rsp.proto == 'dhcp') {
                        ip = rsp.ip['address'];
                        mask = rsp.ip['mask'];
                        gateway = rsp.gw;
                        dns = rsp.dns;
                        if ( $.isArray(dns)) {
                            dns = dns.join('<br>');
                        }
                        if ( ip == '' ) {
                            timer = setTimeout(ask, 2000);
                        } else {
                            clearTimeout( timer );
                        }
                        var statusHTML = StringH.tmpl( $('#tmplWaninfo').html(), {
                            wantype: 'DHCP',
                            ip: ip,
                            mask: mask,
                            gateway: gateway,
                            dns: dns
                        });
                        $( '#wanStatusContent' ).html( statusHTML );
                    } else {
                        ip = rsp.ip['address'];
                        mask = rsp.ip['mask'];
                        gateway = rsp.gw;
                        dns = rsp.dns;
                        if ( $.isArray(dns)) {
                            dns = dns.join('<br>');
                        }
                        var statusHTML = StringH.tmpl( $('#tmplWaninfo').html(), {
                            wantype: 'Static IP address',
                            ip: ip,
                            mask: mask,
                            gateway: gateway,
                            dns: dns
                        });
                        $( '#wanStatusContent' ).html( statusHTML );
                    }
                }
            }
        });
    }
    setTimeout(ask, time);
});

$.sub('switchEvent', function(){
    var timer = null;
    var statusListener = function(){
        //去掉轮寻 因为去掉饼图一些列了 提升性能
        // timer = window.setInterval(function(){
        //     $.pub('status:get');
        // }, 10000);
    };
    var statusStop = function(){
        window.clearInterval(timer);
    }
    var switchTo = function(idx){
        var $tab = $('.nav-tab');
        var $content = $('.nav-tab-content');

        $tab.removeClass('active');
        $tab.eq(idx).addClass('active');

        $content.hide();
        $content.eq(idx).show();

        if ( idx == 1 ) {
            statusListener();
            location.hash = 'router';
        } else {
            statusStop();
        }
        if ( idx == 0 ) {
            $.pub('devices:getlist');
            location.hash = 'devices';
        }
        if ( idx == 2 ) {
            $.pub('pppoeStatus');
            location.hash = 'internet';
        }
        // 更新导航tab数据(不需要上来就请求)
        //$.pub('status:get');
    };
    $('.nav-tab').click(function(){
        var idx = $('.nav-tab').index(this);
        if ( $(this).hasClass('active') ) {
            return;
        }
        switchTo(idx);
    });

    var hash = location.hash;
    if ( hash == '') {
        switchTo(1);
    }else{
        if (/devices/.test(hash)) {
            switchTo(0);
        }
        if (/router/.test(hash)) {
            switchTo(1);
        }
        if (/internet/.test(hash)) {
            switchTo(2);
        }
    }

});

$.sub('speedTestAuto', function(){
    if ( G_FEATURES.apps.qos === '1') {
        $.ajax({
            url: '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/misystem/active',
            type: 'GET',
            datatype: 'json',
            async: aysyc,
            success: function( rsp ){
                rsp =  $.parseJSON(rsp);  
            if ( rsp.code !== 0 ) {
                alert( rsp.msg );
            } else {
                $.pub('speed:history');
            }
        }
        });
    }
});

$.sub('newguide', function(){
    var needGuide = $.cookie('needguide'),
        ht = $( document ).height();
    if ( needGuide === '1' ) {
        $('#newguide').css('height', ht).show();
    }
    $('#newguide').click(function( e ){
        e.preventDefault();
        $( this ).hide();
        $.removeCookie('needguide', {
            path: '/'
        });
    });
});




$.sub( 'taskquery', function(){

    var ajaxqueen = new AjaxQueue;
    // 开始查询系统资源使用情况
    ajaxqueen.addToQueue(taskcollect);
    // 获取查询系统资源使用情况的结果
    ajaxqueen.addToQueue(taskquery);

    function taskcollect(){
        var countryCode = 'cn',
            edata = edata || {callback: function(){}},
            api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqdatacenter/request',
            data = {payload: '{"api":642,"sleeptime":2,"country":"'+ countryCode +'"}'},
            success = function(rsp){
                rsp =  $.parseJSON(rsp);  
                if (rsp.code === 0) {
                    ajaxqueen.next();
                } else {
                    ajaxqueen.retry(3);
                }
            };

         $.ajax({
            url: api,
            type: 'GET',
            datatype: 'json',
            async: aysyc,
            data: data,
            success: success
        });
    }

    function taskquery(){
        var api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqdatacenter/request',
            data = {payload: '{"api":643, "QueryCategory":1}'},
            tplTask = $('#tmpl-task').html(),
            appInfos = [],
            success = function(rsp){
                rsp =  $.parseJSON(rsp);  
                if (rsp.code === 0 && rsp.hasQueried === 1) {

                    appInfos = rsp.appInfos;
                    appInfos.sort(function(a, b){
                        return b.cpu - a.cpu;
                    });

                    if (!$.dialogTask) {
                        $.dialogTask = $.dialog({
                            title: 'Task Manager',
                            content: tplTask.tmpl({appInfos: appInfos, order: 'orderbycpu-up'}),
                            lock: true,
                            beforeunload: function(){
                                console.log('$.dialogTask close');
                                $.dialogTask = null;
                            }
                        });
                    } else {
                        $.dialogTask.content( tplTask.tmpl({appInfos: appInfos, order: 'orderbycpu-up'}) );
                    }

                    $.Cache.set('appInfos', appInfos);

                    $.pub( 'loading:stop' );
                } else {
                    setTimeout(function(){
                        ajaxqueen.retry(10);
                    }, 1000);
                }
            };
        $.ajax({
            url: api,
            type: 'GET',
            datatype: 'json',
            data: data,
            async: aysyc,
            success: success
        });
    }

} );

$.sub( 'taskinit', function(){

    var tplTask = $('#tmpl-task').html();

    // 激活关闭插件
    function taskkill(appid, status){
        var api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqdatacenter/request',
            data = {payload: '{"api":606,"pluginID": "'+ appid +'","status":' + status + '}'},
            success = function(rsp){
                rsp =  $.parseJSON(rsp);  
                if (rsp.code === 0) {
                    $.pub('taskquery');
                } else {
                    alert(rsp.msg);
                }
            };
            $.ajax({
                url: api,
                type: 'GET',
                datatype: 'json',
                data: data,
                async: aysyc,
                success: success
            });
        $.pub( 'loading:start' );
    }

    // add event
    var $body = $(document.body);
    $body.delegate('.gettasklist', 'click', function(e){
        e.preventDefault();
        $.pub( 'loading:start' );
        $.pub('taskquery');
    });

    $body.delegate('.killtask', 'click', function(e){
        e.preventDefault();
        var self = this,
            appid = $(self).attr('data-id'),
            status = $(self).attr('data-status'),
            pname = $(self).attr('data-pname');
        if (status === '5') {
            if (appid !== 'xunlei') {
                $.confirm('When session {$pname} ends, related features won&#39;t work. If you want to use again, you shall start the task in this page. End {$pname}?'.tmpl({pname: pname}), function(){
                    taskkill(appid, 7);
                });
            } else {
                $.dialogTaskXunlei = $.dialog({
                    width: 400,
                    title: 'Attention',
                    content: '<p style="text-align:left;">If downloading slows down router&#39;s network speed, you can tap &#34;pause all downloads&#34; to recovery.</p><div style="padding:30px 0;"><button type="button" class="btn btn-dft btn-l" id="stopdowntask"><span>Pause all downloads</span></button><button type="button" class="btn btn-dft btn-l" id="killxunlei" data-id="'+appid+'" style="margin-top:15px;"><span>End task</span></button></div>'
                });
            }
        }
        if (status === '7' || status === '6') {
            taskkill(appid, 5);
        }

    });

    $body.delegate('#stopdowntask', 'click', function(e){
        e.preventDefault();
        var api = '/cgi-bin/luci/;stok=16cf6435aa9503c8dcabc0f75e67dcfb/api/xqdatacenter/request',
            data = {payload: '{"api":516}'};
            $.ajax({
            url: api,
            type: 'GET',
            datatype: 'json',
            data: data,
            async: aysyc,
            success: function(rsp){
                rsp =  $.parseJSON(rsp);  
            if (rsp.code === 0) {
                $.dialogTaskXunlei.close();
            } else {
                $.alert(rsp.msg);
            }
        }
        });

    });

    $body.delegate('#killxunlei', 'click', function(e){
        e.preventDefault();
        var appid = $(this).attr('data-id');
        $.dialogTaskXunlei.close();
        taskkill(appid, 7);
    });

    $body.delegate('.orderbycpu', 'click', function(e){
        e.preventDefault();
        var sortfn ,cls , tr = this.parentNode.parentNode,
            appInfos = $.Cache.get('appInfos');
        if ($(tr).hasClass('orderbycpu-up')) {
            sortfn = function(a, b){
                return a.cpu - b.cpu;
            };
            cls = 'orderbycpu-down';
        } else {
            sortfn = function(a, b){
                return b.cpu - a.cpu;
            };
            cls = 'orderbycpu-up';
        }
        appInfos.sort(sortfn);
        $.dialogTask.content(tplTask.tmpl({appInfos: appInfos, order: cls}));
    })
    .delegate('.orderbymem', 'click', function(e){
        e.preventDefault();
        var sortfn ,cls, tr = this.parentNode.parentNode,
            appInfos = $.Cache.get('appInfos');
        if ($(tr).hasClass('orderbymem-up')) {
            sortfn = function(a, b){
                return a.mem - b.mem;
            };
            cls = 'orderbymem-down';
        } else {
            sortfn = function(a, b){
                return b.mem - a.mem;
            };
            cls = 'orderbymem-up';

        }
        appInfos.sort(sortfn);
        $.dialogTask.content(tplTask.tmpl({appInfos: appInfos, order: cls}));
    });
});


$(function(){
    $.pub('netdiagnosis');
    $.pub('wifi:get');
    $.pub('speed:history');
    //$.pub('status:get');
    $.pub('status:newget');
    $.pub('devices:addevent');
    $.pub('switchEvent');
    $.pub('newguide');
    $.pub('taskinit');
});
</script>

</body>
</html>
